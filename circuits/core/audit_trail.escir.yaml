# SynergyCarbon Audit Trail — Core SmartCircuit
# Proprietary — SynergyCarbon

escir: "0.8.1"
name: sc_audit_trail
version: "1.0.0"
license: "Proprietary"

metadata:
  circuit_id: sc.core.audit_trail.v1
  name: "SynergyCarbon Audit Trail"
  description: |
    Immutable, ML-DSA-87-signed audit log for all platform operations.
    Captures credit issuance, transfers, retirements, marketplace activity,
    access events, and governance actions. Supports regulatory export to
    GHG Protocol, Verra VCS, Gold Standard, ISCC, and SOC2 formats. Enforces
    10-year retention for compliance.
  category: cloud

  implementation:
    software:
      runtime: estream-kernel
      language: rust
      estimated_memory_mb: 64

# =============================================================================
# Type Definitions
# =============================================================================

types:
  AuditConfig:
    kind: struct
    fields:
      - name: retention_days
        type: u32
        default: 3650
      - name: signing_key_id
        type: "string(64)"
        description: "Platform ML-DSA-87 signing key identifier"
      - name: export_batch_size
        type: u32
        default: 10000

  AuditEvent:
    kind: struct
    description: "A single auditable event"
    fields:
      - name: event_id
        type: "bytes(32)"
        description: "SHA3-256 hash of event contents"
      - name: timestamp_us
        type: u64
      - name: actor
        type: "bytes(32)"
        description: "Spark-authenticated identity that performed the action"
      - name: actor_type
        type: ActorType
      - name: action
        type: AuditAction
      - name: subject_type
        type: "string(32)"
        description: "credit | attestation | listing | trigger | governance"
      - name: subject_id
        type: "bytes(32)"
      - name: details
        type: EventDetails
      - name: signature
        type: "bytes(2420)"
        description: "ML-DSA-87 platform signature over event"
      - name: prev_event_hash
        type: "bytes(32)"
        description: "Hash chain: SHA3-256 of previous event_id"

  ActorType:
    kind: enum
    variants:
      - User
      - SmartCircuit
      - ApiKey
      - Trigger
      - System

  AuditAction:
    kind: enum
    variants:
      - CreditIssued
      - CreditTransferred
      - CreditRetired
      - CreditCancelled
      - CreditListed
      - CreditSold
      - AttestationVerified
      - AttestationRejected
      - TriggerCreated
      - TriggerDeleted
      - TriggerFired
      - MethodologyApproved
      - VerifierRegistered
      - ParameterUpdated
      - AccessGranted
      - AccessDenied
      - ExportRequested
      # Forward contract events
      - ContractProposed
      - ContractAccepted
      - ContractTerminated
      - ContractSettled
      - ContractDefaulted
      # Marketplace events
      - OrderPlaced
      - EscrowLocked
      - FundsReleased
      # Governance voting
      - ProposalCreated
      - VoteCast
      # AI events
      - ForecastGenerated
      - RLHFFeedbackReceived
      # Certificate
      - CertificateGenerated
      # Auditor access
      - AuditorAccessGranted
      - AuditorAccessRevoked

  EventDetails:
    kind: struct
    description: "Before/after state for the audited action"
    fields:
      - name: before_state
        type: "string(1024)"
        description: "JSON-serialized state before action (null for creates)"
      - name: after_state
        type: "string(1024)"
        description: "JSON-serialized state after action"
      - name: metadata
        type: "string(512)"
        description: "Additional context (IP, API key prefix, trigger config)"

  ExportRequest:
    kind: struct
    description: "Request to export audit data for regulatory compliance"
    fields:
      - name: export_id
        type: "bytes(32)"
      - name: format
        type: ExportFormat
      - name: start_time
        type: u64
      - name: end_time
        type: u64
      - name: filter_actions
        type: "list(string(32))"
        description: "Filter to specific action types (empty = all)"
      - name: filter_subjects
        type: "list(bytes(32))"
        description: "Filter to specific subjects (empty = all)"
      - name: requester
        type: "bytes(32)"
      - name: requested_at
        type: u64

  ExportFormat:
    kind: enum
    variants:
      - GHGProtocol_CSV
      - GHGProtocol_XLSX
      - VerraVCS_JSON
      - GoldStandard_JSON
      - ISCC_JSON
      - SOC2_JSON
      - Raw_JSON

  ExportResult:
    kind: struct
    fields:
      - name: export_id
        type: "bytes(32)"
      - name: format
        type: ExportFormat
      - name: event_count
        type: u64
      - name: file_hash
        type: "bytes(32)"
        description: "SHA3-256 of the exported file"
      - name: download_url
        type: "string(256)"
      - name: generated_at
        type: u64

  AuditStats:
    kind: struct
    fields:
      - name: total_events
        type: u64
      - name: events_today
        type: u32
      - name: chain_length
        type: u64
        description: "Length of hash chain (integrity check)"
      - name: chain_valid
        type: bool
        description: "Hash chain integrity status"
      - name: exports_total
        type: u32
      - name: oldest_event_time
        type: u64

# =============================================================================
# Circuit Interface
# =============================================================================

inputs:
  - name: config
    type: AuditConfig

  - name: event_in
    type: AuditEvent
    description: "Incoming audit event (from any SC circuit)"

  - name: event_valid
    type: bool

  - name: export_request
    type: ExportRequest
    description: "Request to export audit data"

  - name: export_valid
    type: bool

outputs:
  - name: event_stored
    type: AuditEvent
    description: "Stored and signed event → sc.audit.events"

  - name: stored_valid
    type: bool

  - name: export_result
    type: ExportResult
    description: "Completed export → sc.audit.exports"

  - name: export_result_valid
    type: bool

  - name: stats
    type: AuditStats

# =============================================================================
# Annotations
# =============================================================================

annotations:
  witness_tier: "audit"
  deterministic: true
  streamsight_emit: true
  tamper_evident: true
  hash_chain: true
  precision_class: B
  alert_on_error: E7030
  resource_metering:
    hardware_base: 0.004
    operations_base: 0.006
    budget: 200000000

# =============================================================================
# Governance Events (v0.8.1)
# =============================================================================

governance_events:
  on_success:
    type: AUDIT_EVENT_RECORDED
    code: "0x76"
    payload:
      event_id: output.event.event_id
      action: output.event.action
      subject: output.event.subject
  on_error:
    type: AUDIT_RECORD_FAILED
    code: "0x77"
    payload:
      error_code: output.error_code

# =============================================================================
# StreamSight Integration
# =============================================================================

streamsight:
  namespace: "sc.audit"

  emit:
    - event: "event_recorded"
      topic: "lex://sc/audit/events"
      severity: info
      fields: ["event_id", "actor", "action", "subject_type", "subject_id"]

    - event: "chain_integrity_check"
      topic: "lex://sc/audit/events"
      severity: info
      rate_limit_hz: 0.000278
      fields: ["chain_length", "chain_valid"]

    - event: "export_completed"
      topic: "lex://sc/audit/exports"
      severity: info
      fields: ["export_id", "format", "event_count", "file_hash"]

    - event: "chain_break_detected"
      topic: "lex://sc/audit/events"
      severity: critical
      fields: ["expected_prev_hash", "actual_prev_hash", "broken_at_event"]

# =============================================================================
# Compute Graph
# =============================================================================

compute:
  nodes:
    # Event processing
    - id: event_id_hasher
      type: crypto_hash
      description: "Compute event_id = SHA3-256 of event contents"
      algorithm: SHA3-256

    - id: chain_linker
      type: transform
      description: "Set prev_event_hash from last stored event"

    - id: event_signer
      type: crypto_sign
      description: "ML-DSA-87 sign the event with platform key"
      algorithm: ML-DSA-87
      key_source: config.signing_key_id

    - id: chain_verifier
      type: comparator
      description: "Verify hash chain continuity"
      operation: "event.prev_event_hash == last_stored.event_id"

    - id: event_store
      type: append_log
      description: "Immutable append-only event log"
      retention_days: config.retention_days

    # Export processing
    - id: event_filter
      type: filter
      description: "Filter events by action, subject, time range"

    - id: format_renderer
      type: transform
      description: "Render filtered events to requested format"

    - id: export_hasher
      type: crypto_hash
      description: "SHA3-256 hash of exported file"
      algorithm: SHA3-256

    - id: export_store
      type: blob_store
      description: "Store exported file for download"

    # Stats
    - id: event_counter
      type: counter
      width: 64
    - id: export_counter
      type: counter
      width: 32

  flows:
    # Event recording
    - event_in -> event_id_hasher
    - event_id_hasher -> chain_linker
    - chain_linker -> chain_verifier
    - chain_verifier.valid -> event_signer
    - chain_verifier.invalid -> streamsight.chain_break_detected
    - event_signer -> event_store
    - event_store.success -> event_stored
    - event_store.success -> stored_valid
    - event_store.success -> event_counter.increment

    # Export
    - export_request -> event_filter
    - event_filter -> format_renderer
    - format_renderer -> export_hasher
    - export_hasher -> export_store
    - export_store.success -> export_result
    - export_store.success -> export_result_valid
    - export_store.success -> export_counter.increment

# =============================================================================
# Test Vectors
# =============================================================================

tests:
  - name: "Event stored with hash chain"
    steps:
      - setup:
          config: { retention_days: 3650 }
      - input:
          event_in:
            actor: "0xSYSTEM"
            actor_type: SmartCircuit
            action: CreditIssued
            subject_type: "credit"
            subject_id: "0xCRED001"
          event_valid: true
      - expect:
          stored_valid: true
          event_stored:
            action: CreditIssued

  - name: "GHG Protocol export"
    steps:
      - setup: { config: {} }
      - input:
          export_request:
            format: GHGProtocol_CSV
            start_time: 1700000000
            end_time: 1700100000
          export_valid: true
      - expect:
          export_result_valid: true
          export_result:
            format: GHGProtocol_CSV

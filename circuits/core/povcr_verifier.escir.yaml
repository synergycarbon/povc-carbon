# SynergyCarbon PoVCR Verifier — Core SmartCircuit
# Proprietary — SynergyCarbon

escir: "0.8.0"
name: sc_povcr_verifier
version: "1.0.0"
license: "Proprietary"

metadata:
  circuit_id: sc.core.povcr_verifier.v1
  name: "SynergyCarbon PoVCR Verifier"
  description: |
    Platform-level SmartCircuit that receives witness submissions from
    tenant carbon minter circuits (e.g., ThermogenZero tz.cloud.carbon_minter.v1),
    performs independent verification (ML-DSA-87 signature, VRF proof,
    quorum consensus, energy claim validation, historical baseline),
    computes carbon yield using the registered methodology, and produces
    verified attestation records for the Credit Registry.
  category: cloud

  implementation:
    software:
      runtime: estream-kernel
      language: rust
      estimated_memory_mb: 256

# =============================================================================
# Type Definitions
# =============================================================================

types:
  VerifierConfig:
    kind: struct
    fields:
      - name: quorum_size
        type: u8
        description: "Required witness quorum for attestation"
        default: 3
      - name: quorum_window_s
        type: u32
        description: "Window for collecting quorum witnesses (seconds)"
        default: 300
      - name: max_energy_deviation_pct
        type: f32
        description: "Maximum allowed energy claim deviation (%)"
        default: 5.0
      - name: baseline_deviation_pct
        type: f32
        description: "Maximum deviation from 30-day rolling baseline (%)"
        default: 20.0
      - name: baseline_window_days
        type: u32
        default: 30
      - name: audit_retention_days
        type: u32
        default: 3650

  # --- Input types (from tenant minter circuits) ---

  WitnessSubmission:
    kind: struct
    description: "Incoming PoVC witness from a tenant minter circuit"
    fields:
      - name: tenant_id
        type: "string(64)"
        description: "Tenant identifier (e.g., 'thermogenzero')"
      - name: epoch_id
        type: u32
      - name: site_id
        type: "bytes(32)"
      - name: merkle_root
        type: "bytes(32)"
      - name: total_energy_wh
        type: f32
      - name: avg_power_w
        type: f32
      - name: channel_count
        type: u16
      - name: gas_consumed_mcf
        type: f32
        description: "Gas consumed (MCF) — TZ-specific, 0 for solar/wind"
      - name: methodology_id
        type: "string(64)"
        description: "Requested methodology (e.g., 'EPA-AP42-CH4-FLARE')"
      - name: vrf_proof
        type: "bytes(64)"
      - name: signature
        type: "bytes(2420)"
        description: "ML-DSA-87 signature over witness data"
      - name: public_key
        type: "bytes(2592)"
        description: "ML-DSA-87 public key (verified against registry)"
      - name: timestamp_us
        type: u64

  # --- Methodology ---

  Methodology:
    kind: struct
    description: "Registered carbon calculation methodology"
    fields:
      - name: methodology_id
        type: "string(64)"
      - name: name
        type: "string(128)"
      - name: source_types
        type: "string(128)"
        description: "Comma-separated: TEG, solar, wind, CCS"
      - name: gwp_factor
        type: f32
        description: "GWP conversion factor"
      - name: verification_discount
        type: f32
        description: "Conservative discount (e.g., 0.05 = 5%)"
        default: 0.05
      - name: formula_id
        type: "string(32)"
        description: "Calculation formula identifier"
      - name: status
        type: "string(16)"
        description: "approved | test | deprecated"
      - name: approved_at
        type: u64

  # --- Output types ---

  VerifiedAttestation:
    kind: struct
    description: "Verified attestation record ready for credit minting"
    fields:
      - name: attestation_id
        type: "bytes(32)"
        description: "SHA3-256 hash of (tenant_id + epoch_id + site_id + merkle_root)"
      - name: tenant_id
        type: "string(64)"
      - name: epoch_id
        type: u32
      - name: site_id
        type: "bytes(32)"
      - name: merkle_root
        type: "bytes(32)"
      - name: witness_count
        type: u8
      - name: total_energy_wh
        type: f32
        description: "Average energy across quorum witnesses"
      - name: methodology_id
        type: "string(64)"
      - name: tco2e
        type: f32
        description: "Calculated tonnes CO2 equivalent (after discount)"
      - name: co2e_avoided_kg
        type: f32
      - name: carbon_calculation
        type: CarbonCalculation
      - name: confidence_pct
        type: u8
        description: "Verification confidence (0-100)"
      - name: evidence_hash
        type: "bytes(32)"
        description: "SHA3-256 of all witness data + calculation"
      - name: verified_at
        type: u64

  CarbonCalculation:
    kind: struct
    description: "Detailed carbon yield calculation breakdown"
    fields:
      - name: input_fuel_mcf
        type: f32
      - name: fuel_mass_kg
        type: f32
      - name: gwp_factor
        type: f32
      - name: gross_co2e_kg
        type: f32
      - name: parasitic_co2_kg
        type: f32
        description: "CO2 from combustion byproduct"
      - name: net_co2e_kg
        type: f32
      - name: verification_discount
        type: f32
      - name: net_tco2e
        type: f32
      - name: formula_id
        type: "string(32)"

  RejectedWitness:
    kind: struct
    description: "Witness that failed verification"
    fields:
      - name: tenant_id
        type: "string(64)"
      - name: epoch_id
        type: u32
      - name: site_id
        type: "bytes(32)"
      - name: reason
        type: "string(128)"
      - name: rejection_code
        type: u16
        description: "1xx=sig, 2xx=VRF, 3xx=quorum, 4xx=energy, 5xx=baseline, 6xx=methodology"
      - name: rejected_at
        type: u64

  VerifierStatus:
    kind: struct
    fields:
      - name: total_attestations
        type: u64
      - name: total_rejections
        type: u64
      - name: total_tco2e_verified
        type: f64
      - name: pending_quorums
        type: u16
      - name: methodologies_active
        type: u8
      - name: tenants_active
        type: u8
      - name: last_attestation_time
        type: u64

# =============================================================================
# Circuit Interface
# =============================================================================

inputs:
  - name: config
    type: VerifierConfig

  - name: witness_submission
    type: WitnessSubmission
    description: "Incoming PoVC witness from tenant minter"

  - name: witness_valid
    type: bool

  - name: methodology_registry
    type: "[Methodology; 32]"
    description: "Registered methodologies (from governance)"

outputs:
  - name: attestation
    type: VerifiedAttestation
    description: "Verified attestation → Credit Registry"

  - name: attestation_valid
    type: bool

  - name: rejection
    type: RejectedWitness
    description: "Failed witness → audit + alerting"

  - name: rejection_valid
    type: bool

  - name: status
    type: VerifierStatus

# =============================================================================
# Annotations
# =============================================================================

annotations:
  witness_tier: "attestation"
  deterministic: true
  streamsight_emit: true
  audit_trail: true
  governance: "sc.governance"
  multi_tenant: true

# =============================================================================
# StreamSight Integration
# =============================================================================

streamsight:
  namespace: "sc.attestations"

  emit:
    - event: "attestation_verified"
      topic: "lex://sc/attestations/verified"
      severity: info
      fields: ["attestation_id", "tenant_id", "epoch_id", "site_id", "tco2e", "confidence_pct"]

    - event: "witness_rejected"
      topic: "lex://sc/attestations/rejected"
      severity: warning
      fields: ["tenant_id", "epoch_id", "site_id", "reason", "rejection_code"]

    - event: "quorum_timeout"
      topic: "lex://sc/attestations/rejected"
      severity: warning
      fields: ["tenant_id", "epoch_id", "site_id", "witnesses_received", "quorum_required"]

    - event: "baseline_deviation"
      topic: "lex://sc/audit/events"
      severity: warning
      fields: ["tenant_id", "site_id", "current_energy_wh", "baseline_avg_wh", "deviation_pct"]

    - event: "verifier_status"
      topic: "lex://sc/governance/parameters"
      severity: info
      rate_limit_hz: 0.0167
      fields: ["total_attestations", "total_rejections", "total_tco2e_verified", "pending_quorums"]

# =============================================================================
# Compute Graph
# =============================================================================

compute:
  nodes:
    # Step 1: Signature verification
    - id: signature_verifier
      type: crypto_verify
      description: "Verify ML-DSA-87 witness signatures against registered public keys"
      algorithm: ML-DSA-87
      key_source: governance_verifier_registry

    # Step 2: VRF validation
    - id: vrf_verifier
      type: crypto_verify
      description: "Verify VRF proof of witness selection for this epoch"
      algorithm: VRF

    # Step 3: Key registry lookup
    - id: key_registry_check
      type: lookup
      description: "Verify public key is registered for this (tenant, site)"
      key_type: "(string(64), bytes(32))"

    # Step 4: Quorum collection
    - id: quorum_collector
      type: map
      description: "Collect verified witnesses per (tenant, epoch, site)"
      capacity: 10000
      key_type: "(string(64), u32, bytes(32))"
      value_type: "[WitnessSubmission; 10]"
      ttl_s: config.quorum_window_s

    # Step 5: Quorum checker
    - id: quorum_checker
      type: comparator
      description: "Check if quorum reached"
      operation: "witnesses.len() >= config.quorum_size"

    # Step 6: Merkle root consensus
    - id: merkle_consensus
      type: comparator
      description: "Verify quorum witnesses agree on merkle root (supermajority)"
      operation: |
        mode_root = mode(witnesses[*].merkle_root)
        agreement_count = count(w for w in witnesses if w.merkle_root == mode_root)
        valid = agreement_count >= ceil(config.quorum_size * 2 / 3)

    # Step 7: Energy claim cross-validation
    - id: energy_validator
      type: comparator
      description: "Cross-validate energy claims across witnesses"
      operation: |
        avg_energy = mean(witnesses[*].total_energy_wh)
        max_dev = max(abs(w.total_energy_wh - avg_energy) for w in witnesses)
        valid = max_dev / avg_energy < config.max_energy_deviation_pct / 100.0

    # Step 8: Historical baseline check
    - id: baseline_checker
      type: transform
      description: "Compare against rolling baseline average"
      operation: |
        baseline_avg = rolling_avg(site_energy_history, config.baseline_window_days)
        deviation = abs(current_energy - baseline_avg) / baseline_avg
        if deviation > config.baseline_deviation_pct / 100.0:
          flag_for_review()
          confidence = 50
        else:
          confidence = 95

    # Step 9: Methodology lookup
    - id: methodology_lookup
      type: lookup
      description: "Find registered methodology by ID"
      key_type: "string(64)"

    # Step 10: Carbon calculation
    - id: carbon_calculator
      type: transform
      description: "Calculate CO2e using registered methodology"
      operation: |
        if methodology.formula_id == "EPA-AP42-CH4-FLARE":
          # Methane avoidance via flare/combustor
          ch4_volume_m3 = gas_consumed_mcf * 28.3168
          fuel_mass_kg = ch4_volume_m3 * 0.6567
          gross_co2e_kg = fuel_mass_kg * methodology.gwp_factor
          parasitic_co2_kg = fuel_mass_kg * (44.0 / 16.0)
          net_co2e_kg = gross_co2e_kg - parasitic_co2_kg
          net_tco2e = (net_co2e_kg / 1000.0) * (1.0 - methodology.verification_discount)
        elif methodology.formula_id == "SOLAR-GRID-OFFSET":
          # Solar displacing grid electricity
          net_tco2e = (total_energy_wh / 1000.0) * grid_emission_factor_kg_per_kwh / 1000.0
        # ... additional formulas

    # Step 11: Attestation builder
    - id: attestation_builder
      type: transform
      description: "Build verified attestation record with evidence hash"

    # Step 12: Evidence hasher
    - id: evidence_hasher
      type: crypto_hash
      description: "SHA3-256 hash of all witness data + calculation"
      algorithm: SHA3-256

    # Step 13: Attestation ID generator
    - id: attestation_id_gen
      type: crypto_hash
      description: "Deterministic attestation ID from (tenant, epoch, site, root)"
      algorithm: SHA3-256

    # Step 14: Rejection builder
    - id: rejection_builder
      type: transform
      description: "Build rejected witness record with reason"

    # Step 15: Audit logger
    - id: audit_log
      type: append_log
      description: "Immutable audit trail of all verification decisions"
      retention_days: config.audit_retention_days

  flows:
    # Signature + VRF verification (parallel)
    - witness_submission -> signature_verifier
    - witness_submission -> vrf_verifier
    - witness_submission -> key_registry_check

    # Rejection on signature failure
    - signature_verifier.invalid -> rejection_builder { reason: "Invalid ML-DSA-87 signature", code: 100 }
    - vrf_verifier.invalid -> rejection_builder { reason: "Invalid VRF proof", code: 200 }
    - key_registry_check.miss -> rejection_builder { reason: "Public key not registered", code: 101 }

    # Quorum accumulation
    - signature_verifier.valid & vrf_verifier.valid & key_registry_check.hit -> quorum_collector.add

    # Quorum evaluation
    - quorum_collector.updated -> quorum_checker
    - quorum_checker.reached -> merkle_consensus
    - quorum_checker.timeout -> rejection_builder { reason: "Quorum timeout", code: 300 }

    # Merkle + energy validation
    - merkle_consensus.valid -> energy_validator
    - merkle_consensus.invalid -> rejection_builder { reason: "Merkle root disagreement", code: 301 }
    - energy_validator.valid -> baseline_checker
    - energy_validator.invalid -> rejection_builder { reason: "Energy claim deviation >5%", code: 400 }

    # Carbon calculation
    - baseline_checker -> methodology_lookup { key: witness.methodology_id }
    - methodology_lookup.hit -> carbon_calculator
    - methodology_lookup.miss -> rejection_builder { reason: "Unknown methodology", code: 600 }
    - carbon_calculator -> attestation_builder

    # Attestation assembly
    - attestation_id_gen -> attestation_builder
    - evidence_hasher -> attestation_builder
    - baseline_checker.confidence -> attestation_builder
    - attestation_builder -> attestation
    - attestation_builder -> attestation_valid

    # Rejection output
    - rejection_builder -> rejection
    - rejection_builder -> rejection_valid

    # Audit trail (both success and failure)
    - attestation_builder -> audit_log
    - rejection_builder -> audit_log

# =============================================================================
# Test Vectors
# =============================================================================

tests:
  - name: "Valid TZ quorum produces attestation"
    steps:
      - setup:
          config: { quorum_size: 3, max_energy_deviation_pct: 5.0, baseline_deviation_pct: 20.0 }
          methodology_registry:
            - { methodology_id: "EPA-AP42-CH4-FLARE", gwp_factor: 28.0, verification_discount: 0.05, formula_id: "EPA-AP42-CH4-FLARE", status: "approved" }
      - repeat: 3
        input:
          witness_submission:
            tenant_id: "thermogenzero"
            epoch_id: 100
            site_id: "0xABCD"
            merkle_root: "0x1234..5678"
            total_energy_wh: 212.5
            gas_consumed_mcf: 0.5
            methodology_id: "EPA-AP42-CH4-FLARE"
            signature: "valid_ml_dsa_87"
          witness_valid: true
      - expect:
          attestation_valid: true
          attestation:
            tenant_id: "thermogenzero"
            epoch_id: 100
            witness_count: 3
            confidence_pct: 95

  - name: "Unregistered key rejected"
    steps:
      - setup:
          config: { quorum_size: 3 }
      - input:
          witness_submission:
            tenant_id: "unknown_tenant"
            epoch_id: 200
            public_key: "0xUNREGISTERED"
            signature: "valid_signature"
          witness_valid: true
      - expect:
          rejection_valid: true
          rejection:
            rejection_code: 101
            reason: "Public key not registered"

  - name: "Energy deviation >5% rejected"
    steps:
      - setup:
          config: { quorum_size: 3, max_energy_deviation_pct: 5.0 }
      - input: { witness_submission: { epoch_id: 300, total_energy_wh: 200.0 }, witness_valid: true }
      - input: { witness_submission: { epoch_id: 300, total_energy_wh: 200.0 }, witness_valid: true }
      - input: { witness_submission: { epoch_id: 300, total_energy_wh: 280.0 }, witness_valid: true }
      - expect:
          rejection_valid: true
          rejection:
            rejection_code: 400

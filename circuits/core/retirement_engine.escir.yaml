# SynergyCarbon Retirement Engine — Core SmartCircuit
# Proprietary — SynergyCarbon

escir: "0.8.1"
name: sc_retirement_engine
version: "1.0.0"
license: "Proprietary"

metadata:
  circuit_id: sc.core.retirement_engine.v1
  name: "SynergyCarbon Retirement Engine"
  description: |
    Handles programmatic carbon credit retirement through four trigger
    types: API call, stream event, schedule (cron), and threshold.
    Validates retirement requests, transitions credit status via the
    Credit Registry, generates PDF certificates with QR codes, and
    dispatches webhooks to registered clients.
  category: cloud

  implementation:
    software:
      runtime: estream-kernel
      language: rust
      estimated_memory_mb: 128

# =============================================================================
# Type Definitions
# =============================================================================

types:
  RetirementConfig:
    kind: struct
    fields:
      - name: idempotency_window_s
        type: u32
        description: "Dedup window for idempotency keys"
        default: 86400
      - name: max_retry_attempts
        type: u8
        default: 5
      - name: retry_base_delay_ms
        type: u32
        description: "Base delay for exponential backoff"
        default: 1000
      - name: batch_max_size
        type: u16
        description: "Maximum credits per batch retirement"
        default: 1000
      - name: certificate_base_url
        type: "string(128)"
        default: "https://sc.estream.dev/verify"
      - name: retirement_fee_usd
        type: f32
        description: "Per-retirement fee"
        default: 0.10

  RetirementRequest:
    kind: struct
    description: "Incoming retirement request (from any trigger type)"
    fields:
      - name: request_id
        type: "bytes(32)"
        description: "Unique request ID"
      - name: trigger_type
        type: TriggerType
      - name: trigger_id
        type: "string(64)"
        description: "ID of the trigger that fired (or 'api' for direct)"
      - name: credit_ids
        type: "list(bytes(32))"
        description: "Credits to retire (1 or batch)"
      - name: requester
        type: "bytes(32)"
        description: "Spark-authenticated requester identity"
      - name: reason
        type: "string(256)"
        description: "Retirement reason (displayed on certificate)"
      - name: idempotency_key
        type: "string(128)"
        description: "Client-provided dedup key"
      - name: webhook_url
        type: "string(256)"
        description: "Optional webhook for completion notification"
      - name: requested_at
        type: u64

  TriggerType:
    kind: enum
    variants:
      - ApiCall
      - StreamEvent
      - Schedule
      - Threshold

  RetirementTrigger:
    kind: struct
    description: "Persistent retirement trigger definition"
    fields:
      - name: trigger_id
        type: "string(64)"
      - name: owner
        type: "bytes(32)"
      - name: trigger_type
        type: TriggerType
      - name: config
        type: TriggerConfig
      - name: status
        type: "string(16)"
        description: "active | paused | deleted"
      - name: created_at
        type: u64
      - name: last_fired_at
        type: u64
      - name: fire_count
        type: u32

  TriggerConfig:
    kind: struct
    description: "Configuration for the trigger (varies by type)"
    fields:
      - name: stream_topic
        type: "string(256)"
        description: "For StreamEvent: lex topic to watch"
      - name: stream_predicate
        type: "string(512)"
        description: "For StreamEvent: predicate expression"
      - name: cron_expression
        type: "string(64)"
        description: "For Schedule: cron expression"
      - name: cron_timezone
        type: "string(32)"
        description: "For Schedule: IANA timezone"
      - name: threshold_metric
        type: "string(64)"
        description: "For Threshold: metric name (balance, cumulative, rate)"
      - name: threshold_condition
        type: "string(16)"
        description: "For Threshold: >, <, =="
      - name: threshold_value
        type: f64
        description: "For Threshold: trigger value"
      - name: quantity_tco2e
        type: f32
        description: "Amount to retire per trigger fire"
      - name: credit_selection
        type: "string(32)"
        description: "oldest_first | newest_first | specific"
      - name: reason_template
        type: "string(256)"
        description: "Retirement reason template"

  RetirementResult:
    kind: struct
    description: "Completed retirement result"
    fields:
      - name: retirement_id
        type: "bytes(32)"
      - name: credit_ids
        type: "list(bytes(32))"
      - name: total_tco2e
        type: f32
      - name: retired_by
        type: "bytes(32)"
      - name: reason
        type: "string(256)"
      - name: certificate_url
        type: "string(256)"
      - name: certificate_hash
        type: "bytes(32)"
        description: "SHA3-256 of the PDF certificate"
      - name: on_chain_tx
        type: "bytes(32)"
        description: "L2 retirement transaction hash"
      - name: retired_at
        type: u64

  RetirementCertificate:
    kind: struct
    description: "Data for PDF certificate generation"
    fields:
      - name: certificate_id
        type: "string(64)"
        description: "SC-RET-{year}-{seq:06d}"
      - name: retirement_id
        type: "bytes(32)"
      - name: credit_ids
        type: "list(bytes(32))"
      - name: total_tco2e
        type: f32
      - name: vintage_year
        type: u16
      - name: project_id
        type: "string(64)"
      - name: methodology_id
        type: "string(64)"
      - name: tenant_name
        type: "string(64)"
      - name: retired_by_name
        type: "string(128)"
      - name: reason
        type: "string(256)"
      - name: attestation_id
        type: "bytes(32)"
      - name: merkle_root
        type: "bytes(32)"
      - name: witness_count
        type: u8
      - name: verify_url
        type: "string(256)"
      - name: qr_code_data
        type: "string(256)"

  WebhookPayload:
    kind: struct
    fields:
      - name: event_type
        type: "string(32)"
        description: "credit.retired"
      - name: retirement_id
        type: "bytes(32)"
      - name: credit_ids
        type: "list(bytes(32))"
      - name: total_tco2e
        type: f32
      - name: certificate_url
        type: "string(256)"
      - name: retired_at
        type: u64

  EngineStats:
    kind: struct
    fields:
      - name: total_retirements
        type: u64
      - name: total_tco2e_retired
        type: f64
      - name: active_triggers
        type: u32
      - name: pending_requests
        type: u16
      - name: failed_retirements
        type: u32
      - name: certificates_generated
        type: u64
      - name: webhooks_delivered
        type: u64

# =============================================================================
# Circuit Interface
# =============================================================================

inputs:
  - name: config
    type: RetirementConfig

  - name: retirement_request
    type: RetirementRequest
    description: "Incoming retirement request (any trigger type)"

  - name: request_valid
    type: bool

  - name: trigger_create
    type: RetirementTrigger
    description: "Create/update a retirement trigger"

  - name: trigger_valid
    type: bool

  - name: trigger_delete_id
    type: "string(64)"
    description: "Delete a trigger by ID"

outputs:
  - name: retirement_result
    type: RetirementResult
    description: "Completed retirement → sc.retirements.completed"

  - name: result_valid
    type: bool

  - name: certificate
    type: RetirementCertificate
    description: "Certificate data → PDF renderer"

  - name: certificate_valid
    type: bool

  - name: webhook_out
    type: WebhookPayload
    description: "Webhook notification → dispatch"

  - name: webhook_valid
    type: bool

  - name: registry_notice
    type: RetirementNotice
    description: "→ Credit Registry to update status"

  - name: registry_notice_valid
    type: bool

  - name: stats
    type: EngineStats

# =============================================================================
# Annotations
# =============================================================================

annotations:
  witness_tier: "execution"
  deterministic: true
  streamsight_emit: true
  audit_trail: true
  governance: "sc.governance"
  precision_class: C
  alert_on_error: E7020
  resource_metering:
    hardware_base: 0.005
    operations_base: 0.008
    budget: 300000000

# =============================================================================
# Governance Events (v0.8.1)
# =============================================================================

governance_events:
  on_success:
    type: CREDIT_RETIRED
    code: "0x74"
    payload:
      credit_id: output.retirement.credit_id
      retired_by: output.retirement.retired_by
      tonnes_co2e: output.retirement.tonnes_co2e
  on_error:
    type: RETIREMENT_FAILED
    code: "0x75"
    payload:
      error_code: output.error_code
      credit_id: input.credit_id

# =============================================================================
# StreamSight Integration
# =============================================================================

streamsight:
  namespace: "sc.retirements"

  emit:
    - event: "retirement_completed"
      topic: "lex://sc/retirements/completed"
      severity: info
      fields: ["retirement_id", "credit_ids", "total_tco2e", "retired_by", "trigger_type", "certificate_url"]

    - event: "retirement_failed"
      topic: "lex://sc/audit/events"
      severity: warning
      fields: ["request_id", "reason", "trigger_type"]

    - event: "trigger_fired"
      topic: "lex://sc/retirements/triggers"
      severity: info
      fields: ["trigger_id", "trigger_type", "quantity_tco2e"]

    - event: "certificate_generated"
      topic: "lex://sc/retirements/certificates"
      severity: info
      fields: ["certificate_id", "retirement_id", "verify_url"]

    - event: "webhook_delivered"
      topic: "lex://sc/audit/events"
      severity: info
      fields: ["retirement_id", "webhook_url", "status_code"]

    - event: "engine_stats"
      topic: "lex://sc/retirements/completed"
      severity: info
      rate_limit_hz: 0.0167
      fields: ["total_retirements", "total_tco2e_retired", "active_triggers"]

# =============================================================================
# Compute Graph
# =============================================================================

compute:
  nodes:
    # Validation
    - id: idempotency_check
      type: lookup
      description: "Check idempotency key not already processed"
      key_type: "string(128)"
      ttl_s: config.idempotency_window_s

    - id: requester_auth
      type: auth_verify
      description: "Verify requester owns the credits or is authorized delegate"
      method: spark

    - id: credit_status_check
      type: lookup
      description: "Verify all credits exist and are in retirable state"
      key_type: "bytes(32)"

    - id: balance_check
      type: comparator
      description: "Verify requester has sufficient credit balance"

    # Execution
    - id: registry_notifier
      type: transform
      description: "Build RetirementNotice for each credit → Credit Registry"

    - id: on_chain_writer
      type: l2_operation
      description: "Write immutable retirement record to eStream L2"
      operation: state_update

    - id: result_builder
      type: transform
      description: "Build RetirementResult"

    # Certificate
    - id: cert_id_generator
      type: counter
      description: "Sequential certificate ID"
      width: 64

    - id: cert_builder
      type: transform
      description: "Build certificate data structure"

    - id: qr_generator
      type: transform
      description: "Generate QR code URL for verification"

    - id: pdf_renderer
      type: external_call
      description: "Render PDF certificate"
      service: pdf_renderer

    # Webhook
    - id: webhook_builder
      type: transform
      description: "Build webhook payload"

    - id: webhook_dispatcher
      type: external_call
      description: "HTTP POST to client webhook URL"
      retry:
        strategy: exponential_backoff
        max_attempts: config.max_retry_attempts
        base_delay_ms: config.retry_base_delay_ms

    # Triggers
    - id: trigger_store
      type: map
      description: "Active retirement trigger definitions"
      key_type: "string(64)"
      value_type: RetirementTrigger

    - id: stream_watcher
      type: stream_subscribe
      description: "Watch lex topics for stream event triggers"

    - id: cron_scheduler
      type: scheduler
      description: "Cron-based schedule triggers"

    - id: threshold_monitor
      type: comparator
      description: "Monitor metrics for threshold triggers"

    # Stats
    - id: retirement_counter
      type: counter
      width: 64
    - id: tco2e_accumulator
      type: accumulator
      width: 64

    # Audit
    - id: audit_log
      type: append_log
      retention_days: 3650

  flows:
    # Retirement request path
    - retirement_request -> idempotency_check
    - idempotency_check.miss -> requester_auth
    - idempotency_check.hit -> result_builder { cached: true }
    - requester_auth.valid -> credit_status_check
    - credit_status_check.all_retirable -> balance_check
    - balance_check.pass -> registry_notifier

    # Registry notification (for each credit)
    - registry_notifier -> registry_notice
    - registry_notifier -> registry_notice_valid

    # On-chain + result
    - registry_notifier -> on_chain_writer
    - on_chain_writer.success -> result_builder
    - result_builder -> retirement_result
    - result_builder -> result_valid
    - result_builder -> retirement_counter.increment
    - result_builder -> tco2e_accumulator.add

    # Certificate generation
    - result_builder -> cert_id_generator.next
    - cert_id_generator -> cert_builder
    - cert_builder -> qr_generator
    - qr_generator -> cert_builder.qr
    - cert_builder -> certificate
    - cert_builder -> certificate_valid
    - cert_builder -> pdf_renderer

    # Webhook dispatch
    - result_builder -> webhook_builder
    - webhook_builder -> webhook_out
    - webhook_builder -> webhook_valid
    - webhook_builder -> webhook_dispatcher

    # Trigger management
    - trigger_create -> trigger_store.upsert
    - trigger_delete_id -> trigger_store.delete

    # Trigger firing
    - stream_watcher.match -> retirement_request { trigger_type: StreamEvent }
    - cron_scheduler.fire -> retirement_request { trigger_type: Schedule }
    - threshold_monitor.crossed -> retirement_request { trigger_type: Threshold }

    # Audit
    - result_builder -> audit_log
    - webhook_dispatcher.result -> audit_log

# =============================================================================
# Test Vectors
# =============================================================================

tests:
  - name: "API retirement with certificate"
    steps:
      - setup:
          config: { certificate_base_url: "https://sc.estream.dev/verify" }
      - input:
          retirement_request:
            request_id: "0xREQ001"
            trigger_type: ApiCall
            credit_ids: ["0xCRED001"]
            requester: "0xBUYER001"
            reason: "Q1 2026 operations offset"
            idempotency_key: "acme-q1-2026"
          request_valid: true
      - expect:
          result_valid: true
          certificate_valid: true
          registry_notice_valid: true
          retirement_result:
            total_tco2e: 1.5
            reason: "Q1 2026 operations offset"

  - name: "Idempotent retry returns cached result"
    steps:
      - setup: { config: { idempotency_window_s: 86400 } }
      # First request
      - input:
          retirement_request: { request_id: "0xREQ002", idempotency_key: "key-001", credit_ids: ["0xCRED002"] }
          request_valid: true
      - expect: { result_valid: true }
      # Retry with same idempotency key
      - input:
          retirement_request: { request_id: "0xREQ003", idempotency_key: "key-001", credit_ids: ["0xCRED002"] }
          request_valid: true
      - expect:
          result_valid: true
          # Returns same retirement_id as first request

  - name: "Batch retirement (multiple credits)"
    steps:
      - setup: { config: { batch_max_size: 1000 } }
      - input:
          retirement_request:
            credit_ids: ["0xCRED010", "0xCRED011", "0xCRED012"]
            requester: "0xBUYER001"
            reason: "Annual offset"
          request_valid: true
      - expect:
          result_valid: true
          retirement_result:
            credit_ids: ["0xCRED010", "0xCRED011", "0xCRED012"]

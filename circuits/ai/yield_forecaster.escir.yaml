# SynergyCarbon AI Yield Forecaster — AI SmartCircuit
# Proprietary — SynergyCarbon

escir: "0.8.0"
name: sc_yield_forecaster
version: "1.0.0"
license: "Proprietary"

metadata:
  circuit_id: sc.ai.yield_forecaster.v1
  name: "SynergyCarbon AI Yield Forecaster"
  description: |
    SLM-based carbon credit yield forecaster. Ingests historical minting
    data, tenant telemetry, fleet health, and weather data via lex topic
    subscriptions. Uses Mamba/S4 SSM architecture with BitNet b1.58
    ternary weights for efficient time-series inference. Produces
    multi-horizon yield forecasts (7d/30d/90d/365d) with confidence
    intervals, seasonal decomposition, and capacity factor projections.
    Continuously backtests against realized minting and emits accuracy
    metrics via StreamSight.
  category: ai

  implementation:
    software:
      runtime: estream-kernel
      language: rust
      estimated_memory_mb: 512
      crate: estream-slm

  ml:
    architecture: mamba_s4_ssm
    weight_format: bitnet_b158
    d_model: 256
    n_layers: 4
    ssm_state_dim: 16
    training_ratio: "0.4 feedback / 0.6 operational"
    training_trigger_samples: 5000
    inference_frequency_s: 3600

# =============================================================================
# Type Definitions
# =============================================================================

types:
  ForecasterConfig:
    kind: struct
    fields:
      - name: inference_interval_s
        type: u32
        description: "How often to refresh forecasts"
        default: 3600
      - name: feature_window_s
        type: u32
        description: "Observation window for feature extraction"
        default: 3600
      - name: ewma_alpha
        type: f32
        description: "EWMA smoothing factor for feature averaging"
        default: 0.1
      - name: baseline_window_days
        type: u32
        description: "Rolling baseline for deviation detection"
        default: 30
      - name: deviation_alert_pct
        type: f32
        description: "Alert threshold for yield deviation (%)"
        default: 20.0
      - name: deviation_alert_hours
        type: u16
        description: "Minimum duration before alert fires"
        default: 48
      - name: confidence_levels
        type: "[f32; 2]"
        description: "Confidence interval levels"
        default: [0.80, 0.95]
      - name: rlhf_operator_weight_max
        type: f32
        description: "Max weight for tier-5 operator feedback"
        default: 2.0

  # --- Corpus types (lex topic subscriptions) ---

  MintEvent:
    kind: struct
    description: "From sc.credits.issued"
    fields:
      - name: tenant_id
        type: "string(64)"
      - name: project_id
        type: "string(64)"
      - name: tco2e
        type: f32
      - name: methodology_id
        type: "string(64)"
      - name: vintage_year
        type: u16
      - name: timestamp
        type: u64

  MarketSnapshot:
    kind: struct
    description: "From sc.marketplace.market_data"
    fields:
      - name: spot_price_usd
        type: f64
      - name: volume_24h_tco2e
        type: f64
      - name: active_listings
        type: u32
      - name: timestamp
        type: u64

  AttestationEvent:
    kind: struct
    description: "From sc.attestations.verified"
    fields:
      - name: tenant_id
        type: "string(64)"
      - name: tco2e
        type: f32
      - name: confidence_pct
        type: u8
      - name: timestamp
        type: u64

  TenantTelemetry:
    kind: struct
    description: "From tz.teg.power (downsampled to 5-min EWMA)"
    fields:
      - name: tenant_id
        type: "string(64)"
      - name: project_id
        type: "string(64)"
      - name: power_mean_w
        type: f32
      - name: capacity_factor
        type: f32
      - name: gas_flow_mcf_hour
        type: f32
      - name: timestamp
        type: u64

  FleetHealth:
    kind: struct
    description: "From tz.fleet.*"
    fields:
      - name: tenant_id
        type: "string(64)"
      - name: active_sites
        type: u16
      - name: degraded_sites
        type: u16
      - name: total_capacity_kw
        type: f32
      - name: timestamp
        type: u64

  WeatherData:
    kind: struct
    description: "From sc.external.weather (ingested from external API)"
    fields:
      - name: ambient_temp_c
        type: f32
      - name: wind_speed_ms
        type: f32
      - name: irradiance_wm2
        type: f32
      - name: timestamp
        type: u64

  ForwardCommitment:
    kind: struct
    description: "From sc.forwards.contracts.active"
    fields:
      - name: tenant_id
        type: "string(64)"
      - name: project_id
        type: "string(64)"
      - name: committed_tco2e
        type: f64
      - name: remaining_tco2e
        type: f64
      - name: timestamp
        type: u64

  # --- Feature vector (extracted from corpus) ---

  FeatureVector:
    kind: struct
    description: "Fixed-width feature vector per observation window"
    fields:
      # Power generation
      - name: power_mean_w
        type: f32
      - name: power_trend_slope
        type: f32
      - name: power_r_squared
        type: f32
      - name: capacity_factor
        type: f32
      # Carbon
      - name: minting_rate_tco2e_day
        type: f32
      - name: gas_flow_mcf_hour
        type: f32
      - name: attestation_success_rate
        type: f32
      # Market
      - name: spot_price_usd
        type: f32
      - name: spot_volume_24h
        type: f32
      - name: forward_committed_tco2e
        type: f32
      # External
      - name: ambient_temp_c
        type: f32
      - name: wind_speed_ms
        type: f32
      - name: irradiance_wm2
        type: f32
      # Calendar (cyclical encoding)
      - name: hour_sin
        type: f32
      - name: hour_cos
        type: f32
      - name: day_sin
        type: f32
      - name: day_cos
        type: f32
      - name: is_weekend
        type: f32

  # --- Output types ---

  YieldForecast:
    kind: struct
    description: "Multi-horizon yield forecast for a tenant/project"
    fields:
      - name: tenant_id
        type: "string(64)"
      - name: project_id
        type: "string(64)"
      - name: forecast_time
        type: u64
      - name: horizons
        type: "[HorizonForecast; 4]"
      - name: model_version
        type: "string(32)"

  HorizonForecast:
    kind: struct
    fields:
      - name: horizon_days
        type: u16
        description: "7, 30, 90, or 365"
      - name: projected_tco2e
        type: f64
      - name: confidence_80_lo
        type: f64
      - name: confidence_80_hi
        type: f64
      - name: confidence_95_lo
        type: f64
      - name: confidence_95_hi
        type: f64
      - name: trend_component
        type: f64
      - name: seasonal_component
        type: f64
      - name: residual_component
        type: f64

  CapacityForecast:
    kind: struct
    description: "Projected capacity factor"
    fields:
      - name: tenant_id
        type: "string(64)"
      - name: project_id
        type: "string(64)"
      - name: current_capacity_factor
        type: f32
      - name: projected_7d
        type: f32
      - name: projected_30d
        type: f32
      - name: projected_90d
        type: f32
      - name: nameplate_kw
        type: f32
      - name: forecast_time
        type: u64

  YieldDeviationAlert:
    kind: struct
    description: "Alert when actual minting deviates from forecast"
    fields:
      - name: tenant_id
        type: "string(64)"
      - name: project_id
        type: "string(64)"
      - name: forecast_tco2e_day
        type: f32
      - name: actual_tco2e_day
        type: f32
      - name: deviation_pct
        type: f32
      - name: duration_hours
        type: u16
      - name: severity
        type: u8
        description: "0=advisory, 1=warning, 2=critical"
      - name: possible_causes
        type: "list(string(64))"

  AccuracyMetrics:
    kind: struct
    fields:
      - name: mae_7d
        type: f64
        description: "Mean absolute error, 7-day horizon"
      - name: mape_30d
        type: f64
        description: "Mean absolute % error, 30-day"
      - name: mape_90d
        type: f64
      - name: r_squared
        type: f64
        description: "Trend component R²"
      - name: sample_count
        type: u64
      - name: model_version
        type: "string(32)"
      - name: last_retrain
        type: u64

  ForecastCorrection:
    kind: struct
    description: "RLHF operator correction"
    fields:
      - name: forecast_id
        type: "bytes(32)"
      - name: correction_type
        type: "string(16)"
        description: "override | bias_adjust | exclude_period"
      - name: corrected_value
        type: f32
      - name: reason
        type: "string(256)"
      - name: operator_tier
        type: u8
        description: "Experience weight (1-5)"

  CorpusStats:
    kind: struct
    fields:
      - name: total_samples
        type: u64
      - name: samples_since_last_train
        type: u32
      - name: ingestion_rate_per_hour
        type: f32
      - name: model_version
        type: "string(32)"
      - name: last_train_time
        type: u64
      - name: next_train_threshold
        type: u32

# =============================================================================
# ML Annotations (ESCIR ML Extensions)
# =============================================================================

ml_model:
  name: sc_yield_ssm
  architecture: mamba_s4

  parameters:
    d_model: 256
    n_layers: 4
    ssm_state_dim: 16
    vocab_size: 0          # Not a language model — continuous features
    input_dim: 18           # FeatureVector field count
    output_dim: 36          # 4 horizons × 9 fields per HorizonForecast

  annotations:
    - "@quantization": "bitnet_b158"
    - "@tensor_shape": "[batch, seq_len, d_model]"
    - "@ssm_scan": { state_dim: 16, dt_rank: "auto" }

  weights:
    format: ternary
    total_params: 1_048_576  # ~1M params (compact SSM)
    storage_bits: 1_572_864  # 1.58 bits per param

# =============================================================================
# Circuit Interface
# =============================================================================

inputs:
  - name: config
    type: ForecasterConfig

  # Corpus inputs (lex topic subscriptions)
  - name: mint_event
    type: MintEvent
    description: "← sc.credits.issued"
  - name: mint_valid
    type: bool

  - name: market_snapshot
    type: MarketSnapshot
    description: "← sc.marketplace.market_data"
  - name: market_valid
    type: bool

  - name: attestation_event
    type: AttestationEvent
    description: "← sc.attestations.verified"
  - name: attestation_valid
    type: bool

  - name: tenant_telemetry
    type: TenantTelemetry
    description: "← tz.teg.power (downsampled)"
  - name: telemetry_valid
    type: bool

  - name: fleet_health
    type: FleetHealth
    description: "← tz.fleet.*"
  - name: fleet_valid
    type: bool

  - name: weather
    type: WeatherData
    description: "← sc.external.weather"
  - name: weather_valid
    type: bool

  - name: forward_commitment
    type: ForwardCommitment
    description: "← sc.forwards.contracts.active"
  - name: commitment_valid
    type: bool

  # RLHF
  - name: correction
    type: ForecastCorrection
    description: "← sc.ai.feedback"
  - name: correction_valid
    type: bool

outputs:
  - name: yield_forecast
    type: YieldForecast
    description: "→ sc.ai.forecasts.yield.{tenant}.{project}"

  - name: forecast_valid
    type: bool

  - name: capacity_forecast
    type: CapacityForecast
    description: "→ sc.ai.forecasts.capacity.{tenant}.{project}"

  - name: capacity_valid
    type: bool

  - name: deviation_alert
    type: YieldDeviationAlert
    description: "→ sc.ai.alerts.yield_deviation"

  - name: alert_valid
    type: bool

  - name: accuracy
    type: AccuracyMetrics
    description: "→ sc.ai.accuracy.yield.*"

  - name: corpus_stats
    type: CorpusStats
    description: "→ sc.ai.corpus.*"

# =============================================================================
# Annotations
# =============================================================================

annotations:
  deterministic: false
  streamsight_emit: true
  audit_trail: true
  ml_model: sc_yield_ssm
  multi_tenant: true
  corpus_scope: "InheritPlatform"

# =============================================================================
# StreamSight Integration
# =============================================================================

streamsight:
  namespace: "sc.ai"

  emit:
    - event: "forecast_updated"
      topic: "lex://sc/ai/forecasts/yield"
      severity: info
      rate_limit_hz: 0.000278    # ~hourly
      fields: ["tenant_id", "project_id", "horizons.projected_tco2e", "model_version"]

    - event: "capacity_updated"
      topic: "lex://sc/ai/forecasts/capacity"
      severity: info
      rate_limit_hz: 0.000278
      fields: ["tenant_id", "project_id", "current_capacity_factor", "projected_30d"]

    - event: "yield_deviation"
      topic: "lex://sc/ai/alerts/yield_deviation"
      severity: warning
      fields: ["tenant_id", "project_id", "deviation_pct", "duration_hours", "possible_causes"]

    - event: "accuracy_report"
      topic: "lex://sc/ai/accuracy/yield"
      severity: info
      rate_limit_hz: 0.000278
      fields: ["mae_7d", "mape_30d", "mape_90d", "r_squared", "model_version"]

    - event: "corpus_stats"
      topic: "lex://sc/ai/corpus/ingestion"
      severity: info
      rate_limit_hz: 0.0167
      fields: ["total_samples", "ingestion_rate_per_hour", "model_version"]

    - event: "model_retrained"
      topic: "lex://sc/ai/corpus/model_version"
      severity: info
      fields: ["model_version", "total_samples", "validation_loss"]

    - event: "rlhf_correction_applied"
      topic: "lex://sc/ai/feedback"
      severity: info
      fields: ["forecast_id", "correction_type", "operator_tier"]

# =============================================================================
# Compute Graph
# =============================================================================

compute:
  nodes:
    # --- Corpus ingestion ---
    - id: feature_extractor
      type: transform
      description: "Extract FeatureVector from latest corpus data (per observation window)"

    - id: ewma_smoother
      type: transform
      description: "EWMA smoothing on raw telemetry (alpha = config.ewma_alpha)"

    - id: trend_regression
      type: transform
      description: "Online linear regression (Welford) on power and minting rate — same pattern as estream trend-detector"

    - id: calendar_encoder
      type: transform
      description: "Cyclical encoding: sin/cos of hour, day-of-year; binary weekend"

    - id: corpus_store
      type: append_log
      description: "Append feature vectors to training corpus"
      retention_days: 365

    # --- SSM inference ---
    - id: ssm_encoder
      type: ml_encode
      description: "Encode FeatureVector sequence into SSM input tensor"
      annotations:
        "@tensor_shape": "[1, seq_len, 18]"

    - id: ssm_inference
      type: ml_inference
      description: "Mamba/S4 SSM forward pass — multi-horizon yield prediction"
      model: sc_yield_ssm
      annotations:
        "@ssm_scan": { state_dim: 16 }
        "@quantization": "bitnet_b158"

    - id: ssm_decoder
      type: ml_decode
      description: "Decode SSM output tensor into HorizonForecast structs"
      annotations:
        "@tensor_shape": "[1, 36]"

    # --- Confidence intervals ---
    - id: confidence_estimator
      type: transform
      description: "Compute confidence intervals from prediction variance and historical error"

    # --- Seasonal decomposition ---
    - id: seasonal_decomposer
      type: transform
      description: "STL-like decomposition: trend + seasonal + residual"

    # --- Backtest accuracy ---
    - id: backtest_engine
      type: transform
      description: "Compare past forecasts against realized minting, compute MAE/MAPE/R²"

    # --- Deviation detection ---
    - id: deviation_detector
      type: comparator
      description: "Alert when actual vs. forecast exceeds threshold for duration"
      operation: |
        deviation = abs(actual - forecast) / forecast
        if deviation > config.deviation_alert_pct / 100.0 AND duration_hours > config.deviation_alert_hours:
          emit alert

    # --- Cause analyzer ---
    - id: cause_analyzer
      type: transform
      description: "Heuristic cause analysis for yield deviations"
      operation: |
        if site_health < 50: "equipment_degradation"
        if days_since_last_mint > 7: "site_offline"
        if gas_flow_mcf == 0: "gas_supply_interruption"
        if ambient_temp > baseline + 15: "thermal_stress"

    # --- RLHF ---
    - id: rlhf_integrator
      type: transform
      description: "Apply operator corrections weighted by tier"

    # --- Training trigger ---
    - id: train_trigger
      type: comparator
      description: "Trigger retraining when corpus reaches threshold"
      operation: "samples_since_last_train >= 5000"

    - id: model_trainer
      type: ml_train
      description: "Retrain SSM on corpus with validation holdout (15%)"
      model: sc_yield_ssm
      validation_split: 0.15
      quality_gate:
        pattern_confidence_min: 0.6
        val_loss_delta_max: 0.05

  flows:
    # Corpus ingestion (all sources → feature extractor)
    - mint_event -> ewma_smoother
    - market_snapshot -> ewma_smoother
    - attestation_event -> ewma_smoother
    - tenant_telemetry -> ewma_smoother
    - fleet_health -> ewma_smoother
    - weather -> ewma_smoother
    - forward_commitment -> ewma_smoother

    - ewma_smoother -> trend_regression
    - ewma_smoother -> calendar_encoder
    - trend_regression -> feature_extractor
    - calendar_encoder -> feature_extractor
    - ewma_smoother -> feature_extractor

    - feature_extractor -> corpus_store
    - corpus_store -> train_trigger

    # SSM inference pipeline
    - feature_extractor -> ssm_encoder
    - ssm_encoder -> ssm_inference
    - ssm_inference -> ssm_decoder
    - ssm_decoder -> confidence_estimator
    - ssm_decoder -> seasonal_decomposer

    # Output assembly
    - confidence_estimator -> yield_forecast
    - seasonal_decomposer -> yield_forecast
    - yield_forecast -> forecast_valid

    # Capacity forecast (derived from yield + nameplate)
    - yield_forecast -> capacity_forecast
    - fleet_health -> capacity_forecast
    - capacity_forecast -> capacity_valid

    # Backtest
    - yield_forecast -> backtest_engine
    - mint_event -> backtest_engine
    - backtest_engine -> accuracy

    # Deviation detection
    - yield_forecast -> deviation_detector
    - mint_event -> deviation_detector
    - deviation_detector.triggered -> cause_analyzer
    - cause_analyzer -> deviation_alert
    - cause_analyzer -> alert_valid

    # RLHF
    - correction -> rlhf_integrator
    - rlhf_integrator -> corpus_store

    # Training
    - train_trigger.reached -> model_trainer
    - model_trainer.success -> corpus_stats

# =============================================================================
# Test Vectors
# =============================================================================

tests:
  - name: "Steady-state yield forecast"
    steps:
      - setup:
          config: { inference_interval_s: 3600, deviation_alert_pct: 20.0 }
      - repeat: 100
        input:
          mint_event: { tenant_id: "thermogenzero", project_id: "tz-wellpad-alpha-01", tco2e: 0.26 }
          mint_valid: true
          tenant_telemetry: { power_mean_w: 212.5, capacity_factor: 0.78, gas_flow_mcf_hour: 0.5 }
          telemetry_valid: true
      - expect:
          forecast_valid: true
          yield_forecast:
            tenant_id: "thermogenzero"
            project_id: "tz-wellpad-alpha-01"

  - name: "Yield deviation alert fires"
    steps:
      - setup:
          config: { deviation_alert_pct: 20.0, deviation_alert_hours: 48 }
      # Establish baseline (steady minting)
      - repeat: 200
        input:
          mint_event: { tenant_id: "thermogenzero", tco2e: 0.26 }
          mint_valid: true
      # Sudden drop
      - repeat: 50
        input:
          mint_event: { tenant_id: "thermogenzero", tco2e: 0.05 }
          mint_valid: true
      - expect:
          alert_valid: true
          deviation_alert:
            severity: 1

# SynergyCarbon Impact Widget — Marketplace SmartCircuit
# Proprietary — SynergyCarbon

escir: "0.8.1"
name: sc_impact_widget
version: "1.0.0"
license: "Proprietary"

metadata:
  circuit_id: sc.marketplace.impact_widget.v1
  name: "SynergyCarbon Impact Widget"
  description: |
    Embeddable real-time impact visualization widget. Aggregates
    retirement data per entity and serves four widget variants:
    Counter (running total), Certificate (visual retirement cert),
    Live Meter (real-time generation), and Leaderboard (multi-entity
    comparison). Updates via WebTransport with < 1s latency from
    retirement to display.
  category: cloud

  implementation:
    software:
      runtime: estream-kernel
      language: rust
      estimated_memory_mb: 64

# =============================================================================
# Type Definitions
# =============================================================================

types:
  WidgetConfig:
    kind: struct
    fields:
      - name: update_debounce_ms
        type: u32
        description: "Debounce interval for WebTransport updates"
        default: 500
      - name: leaderboard_max_entries
        type: u16
        default: 100
      - name: history_retention_days
        type: u32
        default: 365

  EntityImpact:
    kind: struct
    description: "Aggregated impact data for a single entity"
    fields:
      - name: entity_id
        type: "bytes(32)"
      - name: entity_name
        type: "string(128)"
      - name: total_tco2e_retired
        type: f64
      - name: total_credits_retired
        type: u64
      - name: total_tco2e_this_year
        type: f64
      - name: total_tco2e_this_month
        type: f64
      - name: projects_supported
        type: u16
      - name: methodologies_used
        type: "list(string(64))"
      - name: first_retirement_at
        type: u64
      - name: last_retirement_at
        type: u64
      - name: last_updated
        type: u64

  CounterWidget:
    kind: struct
    description: "Data for the counter widget variant"
    fields:
      - name: entity_id
        type: "bytes(32)"
      - name: total_tco2e
        type: f64
      - name: display_unit
        type: "string(8)"
        description: "tCO2e | kgCO2e | lbsCO2e"
      - name: animation_target
        type: f64
        description: "Previous value for count-up animation"

  CertificateWidget:
    kind: struct
    description: "Data for the certificate display widget variant"
    fields:
      - name: entity_id
        type: "bytes(32)"
      - name: latest_retirement_id
        type: "bytes(32)"
      - name: certificate_url
        type: "string(256)"
      - name: total_tco2e
        type: f64
      - name: project_name
        type: "string(128)"
      - name: vintage_year
        type: u16
      - name: verify_url
        type: "string(256)"

  LiveMeterWidget:
    kind: struct
    description: "Data for the live meter widget variant"
    fields:
      - name: entity_id
        type: "bytes(32)"
      - name: current_power_w
        type: f32
        description: "Real-time power generation"
      - name: current_rate_tco2e_per_hour
        type: f64
      - name: today_tco2e
        type: f64
      - name: lifetime_tco2e
        type: f64
      - name: source_type
        type: "string(16)"
        description: "TEG | solar | wind"

  LeaderboardEntry:
    kind: struct
    fields:
      - name: rank
        type: u16
      - name: entity_id
        type: "bytes(32)"
      - name: entity_name
        type: "string(128)"
      - name: total_tco2e
        type: f64
      - name: trend_pct
        type: f32
        description: "Month-over-month change %"

  LeaderboardWidget:
    kind: struct
    description: "Data for the leaderboard widget variant"
    fields:
      - name: entries
        type: "[LeaderboardEntry; 100]"
      - name: entry_count
        type: u16
      - name: period
        type: "string(16)"
        description: "all_time | this_year | this_month"
      - name: updated_at
        type: u64

  WebTransportUpdate:
    kind: struct
    description: "Real-time update pushed to connected widgets"
    fields:
      - name: entity_id
        type: "bytes(32)"
      - name: event_type
        type: "string(32)"
        description: "retirement | generation | leaderboard_change"
      - name: delta_tco2e
        type: f64
      - name: new_total_tco2e
        type: f64
      - name: timestamp
        type: u64

# =============================================================================
# Circuit Interface
# =============================================================================

inputs:
  - name: config
    type: WidgetConfig

  - name: retirement_event
    type: RetirementResult
    description: "From Retirement Engine — new retirement completed"

  - name: retirement_valid
    type: bool

  - name: live_telemetry
    type: LiveMeterWidget
    description: "Real-time telemetry from tenant streams (for Live Meter)"

  - name: telemetry_valid
    type: bool

  - name: widget_request
    type: "string(32)"
    description: "Widget variant request: counter | certificate | live_meter | leaderboard"

outputs:
  - name: counter_data
    type: CounterWidget

  - name: certificate_data
    type: CertificateWidget

  - name: live_meter_data
    type: LiveMeterWidget

  - name: leaderboard_data
    type: LeaderboardWidget

  - name: ws_update
    type: WebTransportUpdate
    description: "Real-time WebTransport push to connected widgets"

  - name: ws_update_valid
    type: bool

# =============================================================================
# Annotations
# =============================================================================

annotations:
  deterministic: false
  streamsight_emit: true
  real_time: true
  webtransport: true
  witness_tier: "presentation"
  precision_class: D
  alert_on_error: E7060
  resource_metering:
    hardware_base: 0.002
    operations_base: 0.003
    budget: 100000000

# =============================================================================
# Governance Events (v0.8.1)
# =============================================================================

governance_events:
  on_success:
    type: IMPACT_UPDATED
    code: "0x7C"
    payload:
      entity_id: output.impact.entity_id
      total_tco2e: output.impact.total_tco2e_retired
  on_error:
    type: IMPACT_UPDATE_FAILED
    code: "0x7D"
    payload:
      error_code: output.error_code

# =============================================================================
# StreamSight Integration
# =============================================================================

streamsight:
  namespace: "sc.impact"

  emit:
    - event: "impact_updated"
      topic: "lex://sc/impact/updates"
      severity: info
      fields: ["entity_id", "total_tco2e_retired", "delta_tco2e"]

    - event: "leaderboard_changed"
      topic: "lex://sc/impact/updates"
      severity: info
      rate_limit_hz: 0.0167
      fields: ["top_entity_name", "top_entity_tco2e"]

# =============================================================================
# Compute Graph
# =============================================================================

compute:
  nodes:
    # Impact aggregation
    - id: entity_store
      type: map
      description: "Per-entity impact aggregation"
      key_type: "bytes(32)"
      value_type: EntityImpact
      capacity: 100000

    - id: retirement_aggregator
      type: transform
      description: "Update entity impact from retirement event"

    # Widget renderers
    - id: counter_renderer
      type: transform
      description: "Render counter widget data from entity impact"

    - id: certificate_renderer
      type: transform
      description: "Render certificate widget data from latest retirement"

    - id: meter_renderer
      type: transform
      description: "Render live meter widget from telemetry"

    - id: leaderboard_builder
      type: sort
      description: "Build leaderboard from all entity impacts"
      sort_key: "total_tco2e_retired"
      order: descending
      limit: config.leaderboard_max_entries

    # WebTransport
    - id: ws_debounce
      type: debounce
      description: "Debounce updates to prevent widget flickering"
      window_ms: config.update_debounce_ms

    - id: ws_broadcaster
      type: broadcast
      description: "Push updates to all connected WebTransport clients for entity"

  flows:
    # Retirement → impact update
    - retirement_event -> retirement_aggregator
    - retirement_aggregator -> entity_store.update
    - entity_store.updated -> counter_renderer -> counter_data
    - entity_store.updated -> certificate_renderer -> certificate_data
    - entity_store.updated -> leaderboard_builder -> leaderboard_data

    # Live telemetry → meter
    - live_telemetry -> meter_renderer -> live_meter_data

    # WebTransport real-time push
    - entity_store.updated -> ws_debounce
    - ws_debounce -> ws_broadcaster -> ws_update
    - ws_debounce -> ws_update_valid

# =============================================================================
# Test Vectors
# =============================================================================

tests:
  - name: "Retirement updates counter widget"
    steps:
      - setup: { config: {} }
      - input:
          retirement_event:
            retirement_id: "0xRET001"
            credit_ids: ["0xCRED001"]
            total_tco2e: 1.5
            retired_by: "0xENTITY001"
          retirement_valid: true
      - expect:
          counter_data:
            total_tco2e: 1.5
          ws_update_valid: true

  - name: "Multiple retirements accumulate"
    steps:
      - setup: { config: {} }
      - input:
          retirement_event: { total_tco2e: 1.0, retired_by: "0xENTITY001" }
          retirement_valid: true
      - input:
          retirement_event: { total_tco2e: 2.5, retired_by: "0xENTITY001" }
          retirement_valid: true
      - expect:
          counter_data:
            total_tco2e: 3.5

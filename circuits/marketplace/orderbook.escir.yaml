# SynergyCarbon Marketplace Orderbook — Marketplace SmartCircuit
# Proprietary — SynergyCarbon

escir: "0.8.1"
name: sc_marketplace_orderbook
version: "1.0.0"
license: "Proprietary"

metadata:
  circuit_id: sc.marketplace.orderbook.v1
  name: "SynergyCarbon Marketplace Orderbook"
  description: |
    Carbon credit marketplace for listing, discovery, and trading of
    verified carbon credits. Supports ask-price listings, filtered
    discovery (vintage, methodology, source type, price range), escrow-
    based settlement via eStream payment channels, and market data
    aggregation.
  category: cloud

  implementation:
    software:
      runtime: estream-kernel
      language: rust
      estimated_memory_mb: 256

# =============================================================================
# Type Definitions
# =============================================================================

types:
  MarketplaceConfig:
    kind: struct
    fields:
      - name: listing_fee_pct
        type: f32
        description: "Fee as percentage of sale price"
        default: 0.5
      - name: min_listing_tco2e
        type: f32
        default: 0.001
      - name: max_listing_duration_days
        type: u32
        default: 365
      - name: escrow_timeout_s
        type: u32
        description: "Escrow release timeout for abandoned orders"
        default: 86400

  Listing:
    kind: struct
    description: "Credit listing on the marketplace"
    fields:
      - name: listing_id
        type: "bytes(32)"
      - name: seller
        type: "bytes(32)"
      - name: credit_ids
        type: "list(bytes(32))"
      - name: total_tco2e
        type: f32
      - name: price_per_tonne_usd
        type: f64
      - name: min_purchase_tco2e
        type: f32
      - name: vintage_year
        type: u16
      - name: credit_type
        type: "string(16)"
        description: "Avoidance | Removal | Sequestration"
      - name: methodology_id
        type: "string(64)"
      - name: project_id
        type: "string(64)"
      - name: tenant_id
        type: "string(64)"
      - name: description
        type: "string(512)"
      - name: status
        type: ListingStatus
      - name: listed_at
        type: u64
      - name: expires_at
        type: u64
      - name: sold_tco2e
        type: f32
        description: "Partial fills accumulate here"

  ListingStatus:
    kind: enum
    variants:
      - Active
      - PartiallyFilled
      - Filled
      - Expired
      - Cancelled

  BuyOrder:
    kind: struct
    description: "Order to purchase credits from a listing"
    fields:
      - name: order_id
        type: "bytes(32)"
      - name: listing_id
        type: "bytes(32)"
      - name: buyer
        type: "bytes(32)"
      - name: quantity_tco2e
        type: f32
      - name: max_price_per_tonne_usd
        type: f64
        description: "Maximum acceptable price (for price protection)"
      - name: ordered_at
        type: u64

  TradeResult:
    kind: struct
    description: "Completed trade between buyer and seller"
    fields:
      - name: trade_id
        type: "bytes(32)"
      - name: listing_id
        type: "bytes(32)"
      - name: order_id
        type: "bytes(32)"
      - name: seller
        type: "bytes(32)"
      - name: buyer
        type: "bytes(32)"
      - name: credit_ids
        type: "list(bytes(32))"
      - name: quantity_tco2e
        type: f32
      - name: price_per_tonne_usd
        type: f64
      - name: total_price_usd
        type: f64
      - name: fee_usd
        type: f64
      - name: settled_at
        type: u64

  SearchQuery:
    kind: struct
    description: "Marketplace search/filter query"
    fields:
      - name: vintage_min
        type: u16
      - name: vintage_max
        type: u16
      - name: credit_type
        type: "string(16)"
        description: "Empty = all types"
      - name: methodology_id
        type: "string(64)"
        description: "Empty = all methodologies"
      - name: tenant_id
        type: "string(64)"
        description: "Empty = all tenants"
      - name: price_min_usd
        type: f64
      - name: price_max_usd
        type: f64
      - name: min_quantity_tco2e
        type: f32
      - name: sort_by
        type: "string(16)"
        description: "price_asc | price_desc | newest | oldest | quantity"
      - name: offset
        type: u32
      - name: limit
        type: u32
        description: "Max results (default 50)"

  MarketData:
    kind: struct
    description: "Aggregated market data snapshot"
    fields:
      - name: timestamp
        type: u64
      - name: total_listed_tco2e
        type: f64
      - name: total_volume_24h_tco2e
        type: f64
      - name: total_volume_24h_usd
        type: f64
      - name: avg_price_per_tonne_usd
        type: f64
      - name: median_price_per_tonne_usd
        type: f64
      - name: active_listings_count
        type: u32
      - name: trades_24h_count
        type: u32

  MarketplaceStats:
    kind: struct
    fields:
      - name: total_listings
        type: u64
      - name: active_listings
        type: u32
      - name: total_trades
        type: u64
      - name: total_volume_tco2e
        type: f64
      - name: total_volume_usd
        type: f64
      - name: total_fees_collected_usd
        type: f64

# =============================================================================
# Circuit Interface
# =============================================================================

inputs:
  - name: config
    type: MarketplaceConfig

  - name: new_listing
    type: Listing
    description: "Create a new listing"

  - name: listing_valid
    type: bool

  - name: buy_order
    type: BuyOrder
    description: "Place a buy order"

  - name: order_valid
    type: bool

  - name: cancel_listing_id
    type: "bytes(32)"
    description: "Cancel a listing by ID"

  - name: search_query
    type: SearchQuery
    description: "Search/filter listings"

outputs:
  - name: listing_created
    type: Listing
    description: "New listing → sc.marketplace.listings.active"

  - name: listing_created_valid
    type: bool

  - name: trade_completed
    type: TradeResult
    description: "Completed trade → sc.marketplace.listings.completed"

  - name: trade_valid
    type: bool

  - name: market_data
    type: MarketData
    description: "Market data snapshot → sc.marketplace.market_data"

  - name: transfer_request
    type: TransferRequest
    description: "→ Credit Registry to transfer ownership"

  - name: transfer_valid
    type: bool

  - name: stats
    type: MarketplaceStats

# =============================================================================
# Annotations
# =============================================================================

annotations:
  witness_tier: "execution"
  deterministic: true
  streamsight_emit: true
  audit_trail: true
  governance: "sc.governance"
  precision_class: C
  alert_on_error: E7040
  resource_metering:
    hardware_base: 0.007
    operations_base: 0.011
    budget: 450000000

# =============================================================================
# Governance Events (v0.8.1)
# =============================================================================

governance_events:
  on_success:
    type: ORDER_SETTLED
    code: "0x78"
    payload:
      listing_id: output.settlement.listing_id
      buyer: output.settlement.buyer
      total_tonnes: output.settlement.total_tonnes
  on_error:
    type: ORDER_FAILED
    code: "0x79"
    payload:
      error_code: output.error_code
      listing_id: input.listing_id

# =============================================================================
# StreamSight Integration
# =============================================================================

streamsight:
  namespace: "sc.marketplace"

  emit:
    - event: "listing_created"
      topic: "lex://sc/marketplace/listings/active"
      severity: info
      fields: ["listing_id", "seller", "total_tco2e", "price_per_tonne_usd", "vintage_year", "methodology_id"]

    - event: "trade_completed"
      topic: "lex://sc/marketplace/listings/completed"
      severity: info
      fields: ["trade_id", "listing_id", "buyer", "seller", "quantity_tco2e", "total_price_usd"]

    - event: "listing_cancelled"
      topic: "lex://sc/marketplace/listings/active"
      severity: info
      fields: ["listing_id", "seller"]

    - event: "listing_expired"
      topic: "lex://sc/marketplace/listings/completed"
      severity: info
      fields: ["listing_id", "seller", "remaining_tco2e"]

    - event: "market_data_update"
      topic: "lex://sc/marketplace/market_data"
      severity: info
      rate_limit_hz: 0.0167
      fields: ["total_listed_tco2e", "avg_price_per_tonne_usd", "trades_24h_count"]

# =============================================================================
# Compute Graph
# =============================================================================

compute:
  nodes:
    # Listing management
    - id: listing_validator
      type: transform
      description: "Validate listing: seller owns credits, min quantity, price > 0"

    - id: listing_store
      type: map
      description: "Active listings indexed by listing_id"
      key_type: "bytes(32)"
      value_type: Listing
      capacity: 100000

    - id: listing_index
      type: index
      description: "Multi-dimensional index for search queries"
      dimensions: ["vintage_year", "credit_type", "methodology_id", "price_per_tonne_usd", "tenant_id"]

    - id: expiration_checker
      type: scheduler
      description: "Check listing expiration"

    # Order processing
    - id: order_matcher
      type: comparator
      description: "Match order to listing: listing active, quantity available, price acceptable"

    - id: escrow_lock
      type: l2_operation
      description: "Lock buyer funds in eStream payment channel"
      operation: escrow_lock

    - id: settlement
      type: transform
      description: "Execute settlement: transfer credits + release funds"

    - id: fee_calculator
      type: transform
      description: "Calculate platform fee from trade"
      operation: "fee = total_price * config.listing_fee_pct / 100.0"

    - id: transfer_builder
      type: transform
      description: "Build transfer request for Credit Registry"

    - id: escrow_release
      type: l2_operation
      description: "Release escrowed funds to seller (minus fee)"
      operation: escrow_release

    # Market data
    - id: trade_accumulator
      type: window_aggregate
      description: "24-hour rolling trade volume"
      window: 86400

    - id: price_aggregator
      type: statistics
      description: "Price statistics (avg, median) from active listings"

    # Stats
    - id: listing_counter
      type: counter
      width: 64
    - id: trade_counter
      type: counter
      width: 64
    - id: volume_accumulator
      type: accumulator
      width: 64
    - id: fee_accumulator
      type: accumulator
      width: 64

    # Audit
    - id: audit_log
      type: append_log
      retention_days: 3650

  flows:
    # Listing creation
    - new_listing -> listing_validator
    - listing_validator.valid -> listing_store.insert
    - listing_store.inserted -> listing_index.add
    - listing_store.inserted -> listing_created
    - listing_store.inserted -> listing_created_valid
    - listing_store.inserted -> listing_counter.increment
    - listing_store.inserted -> audit_log

    # Order matching + settlement
    - buy_order -> order_matcher
    - order_matcher.matched -> escrow_lock
    - escrow_lock.success -> settlement
    - settlement -> fee_calculator
    - settlement -> transfer_builder
    - transfer_builder -> transfer_request
    - transfer_builder -> transfer_valid
    - fee_calculator -> escrow_release
    - escrow_release.success -> trade_completed
    - escrow_release.success -> trade_valid
    - escrow_release.success -> trade_counter.increment
    - escrow_release.success -> volume_accumulator.add
    - escrow_release.success -> fee_accumulator.add
    - escrow_release.success -> trade_accumulator.add
    - escrow_release.success -> audit_log

    # Listing cancellation
    - cancel_listing_id -> listing_store.remove
    - listing_store.removed -> listing_index.remove

    # Expiration
    - expiration_checker.expired -> listing_store.remove

    # Market data aggregation
    - trade_accumulator.snapshot -> market_data
    - price_aggregator.snapshot -> market_data

    # Search
    - search_query -> listing_index.query

# =============================================================================
# Test Vectors
# =============================================================================

tests:
  - name: "List and buy credits"
    steps:
      - setup:
          config: { listing_fee_pct: 0.5 }
      - input:
          new_listing:
            listing_id: "0xLIST001"
            seller: "0xSELLER001"
            credit_ids: ["0xCRED001"]
            total_tco2e: 10.0
            price_per_tonne_usd: 25.0
            vintage_year: 2026
            methodology_id: "EPA-AP42-CH4-FLARE"
          listing_valid: true
      - expect:
          listing_created_valid: true
      - input:
          buy_order:
            listing_id: "0xLIST001"
            buyer: "0xBUYER001"
            quantity_tco2e: 5.0
            max_price_per_tonne_usd: 30.0
          order_valid: true
      - expect:
          trade_valid: true
          trade_completed:
            quantity_tco2e: 5.0
            total_price_usd: 125.0
            fee_usd: 0.625

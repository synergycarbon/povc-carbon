# SynergyCarbon Verra Registry Bridge — SmartCircuit
# Proprietary — SynergyCarbon

escir: "0.8.1"
name: sc_verra_registry_bridge
version: "1.0.0"
license: "Proprietary"

metadata:
  circuit_id: sc.bridge.verra_registry.v1
  name: "SynergyCarbon Verra Registry Bridge"
  description: |
    Cross-registry verification bridge for Verra VCS, Gold Standard, and
    ISCC registries. Performs pre-mint serial dedup checks, post-mint
    registration, retirement synchronization, and methodology mapping.
    Communicates with external registries via the edge proxy (B2B layer)
    and publishes bridge events to lex://sc/bridge/* for Console Kit.
  category: cloud

  implementation:
    software:
      runtime: estream-kernel
      language: rust
      estimated_memory_mb: 128

# =============================================================================
# Type Definitions
# =============================================================================

types:
  BridgeConfig:
    kind: struct
    fields:
      - name: registries_enabled
        type: "list<string(32)>"
        description: "Enabled registry adapters (verra, gold_standard, iscc, cdm)"
        default: ["verra", "gold_standard"]
      - name: dedup_timeout_ms
        type: u32
        description: "Timeout for cross-registry dedup check"
        default: 5000
      - name: sync_interval_s
        type: u32
        description: "Interval for retirement sync with external registries"
        default: 3600
      - name: retry_max
        type: u8
        default: 3

  RegistryAdapter:
    kind: enum
    description: "Supported external carbon credit registries"
    variants:
      - Verra        # Verra VCS API
      - GoldStandard  # Gold Standard Registry
      - ISCC          # International Sustainability & Carbon Certification
      - CDM           # Clean Development Mechanism (UNFCCC)

  DedupRequest:
    kind: struct
    description: "Pre-mint cross-registry serial number dedup check"
    fields:
      - name: attestation_id
        type: "bytes(32)"
      - name: serial_number
        type: "string(64)"
      - name: methodology_id
        type: "string(64)"
      - name: vintage_year
        type: u16
      - name: tonnes_co2e
        type: f64
      - name: source_type
        type: "string(32)"

  DedupResult:
    kind: struct
    description: "Result of cross-registry dedup check"
    fields:
      - name: attestation_id
        type: "bytes(32)"
      - name: serial_number
        type: "string(64)"
      - name: is_unique
        type: bool
      - name: conflicts
        type: "list<RegistryConflict>"
      - name: checked_registries
        type: "list<string(32)>"
      - name: check_duration_ms
        type: u32

  RegistryConflict:
    kind: struct
    fields:
      - name: registry
        type: "string(32)"
      - name: external_serial
        type: "string(128)"
      - name: reason
        type: "string(256)"

  RegistrationRequest:
    kind: struct
    description: "Post-mint registration on external registry"
    fields:
      - name: credit_id
        type: "bytes(32)"
      - name: serial_number
        type: "string(64)"
      - name: registry
        type: RegistryAdapter
      - name: methodology_id
        type: "string(64)"
      - name: vintage_year
        type: u16
      - name: tonnes_co2e
        type: f64
      - name: project_name
        type: "string(256)"
      - name: project_location
        type: "string(256)"

  RegistrationResult:
    kind: struct
    fields:
      - name: credit_id
        type: "bytes(32)"
      - name: registry
        type: "string(32)"
      - name: external_id
        type: "string(128)"
      - name: status
        type: "string(16)"
        description: "registered | pending | rejected"
      - name: registered_at
        type: u64

  RetirementSyncRequest:
    kind: struct
    description: "Sync retirement to external registry"
    fields:
      - name: credit_id
        type: "bytes(32)"
      - name: retirement_id
        type: "bytes(32)"
      - name: registry
        type: RegistryAdapter
      - name: external_id
        type: "string(128)"
      - name: beneficiary_name
        type: "string(256)"
      - name: retirement_reason
        type: "string(512)"

  MethodologyMapping:
    kind: struct
    description: "Maps SynergyCarbon methodology to external registry methodology"
    fields:
      - name: sc_methodology_id
        type: "string(64)"
      - name: registry
        type: RegistryAdapter
      - name: external_methodology_id
        type: "string(128)"
      - name: external_methodology_name
        type: "string(256)"
      - name: mapping_status
        type: "string(16)"
        description: "verified | approximate | custom"

# =============================================================================
# Inputs
# =============================================================================

inputs:
  - name: dedup_check
    type: DedupRequest
    description: "Pre-mint serial number dedup (called by credit_registry before mint)"
    source: "lex://sc/bridge/dedup/request"

  - name: register_credit
    type: RegistrationRequest
    description: "Post-mint registration on external registry"
    source: "lex://sc/bridge/register/request"

  - name: sync_retirement
    type: RetirementSyncRequest
    description: "Sync retirement event to external registry"
    source: "lex://sc/bridge/retirement/sync"

# =============================================================================
# Outputs
# =============================================================================

outputs:
  - name: dedup_result
    type: DedupResult
    description: "Dedup check result (unique or conflict found)"
    sink: "lex://sc/bridge/dedup/result"

  - name: registration_result
    type: RegistrationResult
    description: "External registry registration result"
    sink: "lex://sc/bridge/register/result"

  - name: retirement_synced
    type: RegistrationResult
    description: "Retirement sync confirmation from external registry"
    sink: "lex://sc/bridge/retirement/synced"

# =============================================================================
# Annotations (v0.8.1)
# =============================================================================

annotations:
  witness_tier: "bridge"
  deterministic: false
  streamsight_emit: true
  audit_trail: true
  governance: "sc.governance"
  precision_class: C
  alert_on_error: E7100
  resource_metering:
    hardware_base: 0.006
    operations_base: 0.010
    budget: 350000000

# =============================================================================
# Governance Events (v0.8.1)
# =============================================================================

governance_events:
  on_success:
    type: REGISTRY_BRIDGE_SYNC
    code: "0x84"
    payload:
      registry: output.registration_result.registry
      external_id: output.registration_result.external_id
      status: output.registration_result.status
  on_error:
    type: REGISTRY_BRIDGE_FAILED
    code: "0x85"
    payload:
      error_code: output.error_code
      registry: input.register_credit.registry

# =============================================================================
# StreamSight Integration
# =============================================================================

streamsight:
  namespace: "sc.bridge"

  emit:
    - event: "dedup_checked"
      topic: "lex://sc/bridge/dedup/result"
      fields: [attestation_id, serial_number, is_unique, checked_registries]

    - event: "credit_registered"
      topic: "lex://sc/bridge/register/result"
      fields: [credit_id, registry, external_id, status]

    - event: "retirement_synced"
      topic: "lex://sc/bridge/retirement/synced"
      fields: [credit_id, registry, external_id]

    - event: "conflict_detected"
      topic: "lex://sc/bridge/conflicts"
      fields: [serial_number, registry, external_serial, reason]
      severity: warning

# =============================================================================
# Compute Graph
# =============================================================================

compute:

  # --- Pre-mint dedup ---
  - node: validate_dedup_request
    op: validate
    description: "Validate dedup request fields"
    inputs: [dedup_check]
    validation:
      - field: serial_number
        check: "non_empty"
      - field: attestation_id
        check: "non_zero"

  - node: query_registries
    op: parallel_lookup
    description: "Query all enabled registries for serial number conflicts"
    inputs: [validate_dedup_request]
    config:
      registries: config.registries_enabled
      timeout_ms: config.dedup_timeout_ms
      retry_max: config.retry_max

  - node: aggregate_results
    op: aggregate
    description: "Combine results from all registry queries"
    inputs: [query_registries]
    output: dedup_result

  # --- Post-mint registration ---
  - node: validate_registration
    op: validate
    description: "Validate registration request and methodology mapping"
    inputs: [register_credit]
    validation:
      - field: credit_id
        check: "non_zero"
      - field: registry
        check: "in_set"
        values: [Verra, GoldStandard, ISCC, CDM]

  - node: map_methodology
    op: lookup
    description: "Map SynergyCarbon methodology to external registry equivalent"
    inputs: [validate_registration]
    key_type: "(string(64), RegistryAdapter)"
    state: "methodology_mappings"

  - node: submit_registration
    op: external_call
    description: "Submit credit to external registry API via edge proxy"
    inputs: [map_methodology]
    config:
      transport: "edge_proxy"
      timeout_ms: 10000

  - node: store_registration
    op: state_write
    description: "Store external registration ID for future reference"
    inputs: [submit_registration]
    state: "registry_registrations"
    output: registration_result

  # --- Retirement sync ---
  - node: validate_sync
    op: validate
    description: "Validate retirement sync request"
    inputs: [sync_retirement]

  - node: lookup_registration
    op: lookup
    description: "Find external registration for this credit"
    inputs: [validate_sync]
    state: "registry_registrations"

  - node: submit_retirement
    op: external_call
    description: "Submit retirement to external registry via edge proxy"
    inputs: [lookup_registration]
    config:
      transport: "edge_proxy"
      timeout_ms: 10000

  - node: confirm_sync
    op: state_write
    description: "Update registration record with retirement status"
    inputs: [submit_retirement]
    output: retirement_synced

  # --- Audit ---
  - node: audit_log
    op: append_log
    description: "Log all bridge operations to audit trail"
    inputs: [aggregate_results, store_registration, confirm_sync]

# =============================================================================
# Tests
# =============================================================================

tests:
  - name: "Dedup check — unique serial"
    inputs:
      dedup_check:
        serial_number: "SC-2026-000001"
        methodology_id: "EPA-AP42-CH4-FLARE"
        vintage_year: 2026
        tonnes_co2e: 1.234
    expected:
      dedup_result:
        is_unique: true
        conflicts: []

  - name: "Dedup check — conflict detected"
    inputs:
      dedup_check:
        serial_number: "DUPLICATE-SERIAL"
    expected:
      dedup_result:
        is_unique: false
        conflicts:
          - registry: "verra"
            reason: "Serial already registered"

  - name: "Registration — Verra VCS"
    inputs:
      register_credit:
        serial_number: "SC-2026-000001"
        registry: Verra
        methodology_id: "EPA-AP42-CH4-FLARE"
    expected:
      registration_result:
        registry: "verra"
        status: "registered"

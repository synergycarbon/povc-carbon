# SynergyCarbon Platform Governance — SmartCircuit
# Proprietary — SynergyCarbon

escir: "0.8.1"
name: sc_governance
version: "1.0.0"
license: "Proprietary"

metadata:
  circuit_id: sc.governance.v1
  name: "SynergyCarbon Platform Governance"
  description: |
    Manages platform-wide governance: methodology approval workflows,
    verifier key registration and revocation, quorum/threshold parameter
    updates, and proposal voting. All governance actions require ML-DSA-87
    signatures from authorized governance key holders. Emits governance
    events to lex://sc/governance/* for real-time Console Kit widget updates.
  category: cloud

  implementation:
    software:
      runtime: estream-kernel
      language: rust
      estimated_memory_mb: 128

# =============================================================================
# Type Definitions
# =============================================================================

types:
  GovernanceConfig:
    kind: struct
    fields:
      - name: governance_quorum
        type: u8
        description: "Required signers for governance actions"
        default: 3
      - name: proposal_voting_window_s
        type: u64
        description: "Duration of voting window for proposals (seconds)"
        default: 604800  # 7 days
      - name: max_active_proposals
        type: u16
        description: "Maximum concurrent active proposals"
        default: 10

  # --- Methodology Management ---

  Methodology:
    kind: struct
    description: "Carbon calculation methodology definition"
    fields:
      - name: methodology_id
        type: "bytes(32)"
      - name: name
        type: "string(128)"
        description: "Human-readable methodology name"
      - name: version
        type: "string(16)"
      - name: source_types
        type: "list<string(32)>"
        description: "Supported energy source types (solar, wind, thermo, biogas, etc.)"
      - name: emission_factor_model
        type: "string(64)"
        description: "Reference to emission factor calculation model"
      - name: baseline_algorithm
        type: "string(64)"
        description: "Baseline determination algorithm (rolling_avg, regression, etc.)"
      - name: validation_rules
        type: "list<ValidationRule>"
        description: "Automated validation constraints"
      - name: registry_compatibility
        type: "list<string(32)>"
        description: "Compatible registries (verra, gold_standard, iscc)"
      - name: approved_at
        type: u64
        description: "Epoch timestamp of approval (0 = pending)"
      - name: approved_by
        type: "list<bytes(32)>"
        description: "Governance key fingerprints that approved"

  ValidationRule:
    kind: struct
    fields:
      - name: field
        type: "string(64)"
      - name: operator
        type: "string(8)"
        description: "gt, lt, gte, lte, eq, range, in_set"
      - name: value
        type: "string(128)"
      - name: error_code
        type: "string(8)"

  # --- Verifier Management ---

  VerifierRegistration:
    kind: struct
    description: "Registered witness verifier key and capabilities"
    fields:
      - name: verifier_id
        type: "bytes(32)"
      - name: public_key
        type: "bytes(1952)"
        description: "ML-DSA-87 public key"
      - name: name
        type: "string(128)"
      - name: capabilities
        type: "list<string(32)>"
        description: "Supported source types this verifier attests"
      - name: max_attestation_rate
        type: u32
        description: "Maximum attestations per epoch"
      - name: registered_at
        type: u64
      - name: status
        type: "string(16)"
        description: "active | suspended | revoked"

  # --- Parameter Management ---

  ParameterUpdate:
    kind: struct
    description: "Platform parameter change request"
    fields:
      - name: parameter_path
        type: "string(128)"
        description: "Dot-delimited parameter path (e.g., verifier.quorum_size)"
      - name: current_value
        type: "string(64)"
      - name: proposed_value
        type: "string(64)"
      - name: effective_epoch
        type: u64
        description: "Epoch when change takes effect"
      - name: rationale
        type: "string(512)"

  # --- Governance Proposals ---

  Proposal:
    kind: struct
    description: "Governance proposal for voting"
    fields:
      - name: proposal_id
        type: "bytes(32)"
      - name: proposal_type
        type: "string(32)"
        description: "methodology_approval | verifier_registration | parameter_change | verifier_revocation"
      - name: title
        type: "string(256)"
      - name: description
        type: "string(2048)"
      - name: payload
        type: "bytes(8192)"
        description: "Serialized action payload (Methodology, VerifierRegistration, or ParameterUpdate)"
      - name: proposer
        type: "bytes(32)"
      - name: votes_for
        type: "list<bytes(32)>"
      - name: votes_against
        type: "list<bytes(32)>"
      - name: status
        type: "string(16)"
        description: "pending | approved | rejected | expired"
      - name: created_at
        type: u64
      - name: expires_at
        type: u64

  GovernanceEvent:
    kind: struct
    description: "Emitted governance event"
    fields:
      - name: event_type
        type: "string(64)"
      - name: proposal_id
        type: "bytes(32)"
      - name: actor
        type: "bytes(32)"
      - name: timestamp
        type: u64
      - name: details
        type: "string(1024)"

# =============================================================================
# Inputs
# =============================================================================

inputs:

  # --- Methodology approval ---
  - name: propose_methodology
    type: Methodology
    description: "Submit a new methodology for governance approval"
    source: "lex://sc/governance/methodology/propose"

  # --- Verifier registration ---
  - name: register_verifier
    type: VerifierRegistration
    description: "Register a new witness verifier key"
    source: "lex://sc/governance/verifier/register"

  # --- Parameter updates ---
  - name: propose_parameter_change
    type: ParameterUpdate
    description: "Propose a platform parameter change"
    source: "lex://sc/governance/parameters/propose"

  # --- Voting ---
  - name: cast_vote
    type: Vote
    description: "Cast a governance vote on an active proposal"
    source: "lex://sc/governance/proposals/vote"

# =============================================================================
# Additional Types (Vote)
# =============================================================================

  Vote:
    kind: struct
    fields:
      - name: proposal_id
        type: "bytes(32)"
      - name: voter
        type: "bytes(32)"
      - name: vote
        type: bool
        description: "true = for, false = against"
      - name: signature
        type: "bytes(4627)"
        description: "ML-DSA-87 signature over (proposal_id || vote || epoch)"

# =============================================================================
# Outputs
# =============================================================================

outputs:

  - name: methodology_approved
    type: Methodology
    description: "Emitted when a methodology reaches quorum approval"
    sink: "lex://sc/governance/methodology/approved"

  - name: verifier_registered
    type: VerifierRegistration
    description: "Emitted when a verifier is registered"
    sink: "lex://sc/governance/verifier/registered"

  - name: parameter_updated
    type: ParameterUpdate
    description: "Emitted when a parameter change takes effect"
    sink: "lex://sc/governance/parameters/updated"

  - name: proposal_result
    type: Proposal
    description: "Emitted when a proposal reaches final state"
    sink: "lex://sc/governance/proposals/result"

  - name: governance_event
    type: GovernanceEvent
    description: "All governance events (for audit trail and Console Kit widget)"
    sink: "lex://sc/governance/events"

# =============================================================================
# Annotations (v0.8.1)
# =============================================================================

annotations:
  witness_tier: "governance"
  deterministic: true
  streamsight_emit: true
  audit_trail: true
  governance: "sc.governance"
  precision_class: B
  alert_on_error: E7090
  resource_metering:
    hardware_base: 0.003
    operations_base: 0.005
    budget: 150000000

# =============================================================================
# Governance Events (v0.8.1)
# =============================================================================

governance_events:
  on_success:
    type: GOVERNANCE_ACTION_EXECUTED
    code: "0x82"
    payload:
      proposal_id: output.proposal_result.proposal_id
      proposal_type: output.proposal_result.proposal_type
      status: output.proposal_result.status
  on_error:
    type: GOVERNANCE_ACTION_FAILED
    code: "0x83"
    payload:
      error_code: output.error_code
      proposal_id: input.cast_vote.proposal_id

# =============================================================================
# StreamSight Integration
# =============================================================================

streamsight:
  namespace: "sc.governance"

  emit:
    - event: "methodology_approved"
      topic: "lex://sc/governance/methodology/approved"
      fields: [methodology_id, name, version, source_types]

    - event: "verifier_registered"
      topic: "lex://sc/governance/verifier/registered"
      fields: [verifier_id, name, capabilities, status]

    - event: "parameter_updated"
      topic: "lex://sc/governance/parameters/updated"
      fields: [parameter_path, proposed_value, effective_epoch]

    - event: "proposal_created"
      topic: "lex://sc/governance/proposals/created"
      fields: [proposal_id, proposal_type, title, proposer]

    - event: "vote_cast"
      topic: "lex://sc/governance/proposals/voted"
      fields: [proposal_id, voter, vote]

    - event: "proposal_resolved"
      topic: "lex://sc/governance/proposals/result"
      fields: [proposal_id, status, votes_for, votes_against]

# =============================================================================
# Compute Graph
# =============================================================================

compute:

  # --- Proposal Creation ---
  - node: validate_proposal
    op: validate
    description: "Validate proposal structure and proposer authorization"
    inputs: [propose_methodology, register_verifier, propose_parameter_change]
    validation:
      - field: proposer
        check: "ml_dsa87_verify"
        description: "Proposer must hold a governance key"
      - field: proposal_type
        check: "in_set"
        values: [methodology_approval, verifier_registration, parameter_change, verifier_revocation]

  - node: create_proposal
    op: create
    description: "Create and store the proposal in governance state"
    inputs: [validate_proposal]
    output: proposal_result
    state_write: "governance_proposals"

  # --- Voting ---
  - node: validate_vote
    op: validate
    description: "Validate vote signature and voter authorization"
    inputs: [cast_vote]
    validation:
      - field: signature
        check: "ml_dsa87_verify"
        description: "Vote must be signed by a governance key"
      - field: proposal_id
        check: "exists_in_state"
        state: "governance_proposals"

  - node: tally_votes
    op: aggregate
    description: "Count votes and check quorum threshold"
    inputs: [validate_vote]
    config:
      quorum: config.governance_quorum
      window: config.proposal_voting_window_s

  - node: execute_action
    op: conditional
    description: "Execute governance action if quorum reached"
    inputs: [tally_votes]
    branches:
      - condition: "votes_for >= config.governance_quorum"
        action: approve_proposal
      - condition: "votes_against >= config.governance_quorum"
        action: reject_proposal
      - condition: "now() > proposal.expires_at"
        action: expire_proposal

  # --- Action Execution ---
  - node: approve_proposal
    op: dispatch
    description: "Execute the approved action based on proposal type"
    inputs: [execute_action]
    dispatch:
      methodology_approval:
        output: methodology_approved
        state_write: "approved_methodologies"
      verifier_registration:
        output: verifier_registered
        state_write: "registered_verifiers"
      parameter_change:
        output: parameter_updated
        state_write: "platform_parameters"
      verifier_revocation:
        state_write: "registered_verifiers"
        action: "set_status(revoked)"

  - node: emit_governance_event
    op: emit
    description: "Emit governance event for audit trail and Console Kit"
    inputs: [approve_proposal, reject_proposal, expire_proposal]
    output: governance_event

# =============================================================================
# Tests
# =============================================================================

tests:

  - name: "Methodology approval — happy path"
    description: "Submit methodology, collect quorum votes, verify approval"
    inputs:
      propose_methodology:
        methodology_id: "0xAABB...0001"
        name: "Thermoelectric Waste Heat v1.0"
        version: "1.0.0"
        source_types: [thermoelectric]
        emission_factor_model: "grid_displacement_marginal"
        baseline_algorithm: "rolling_avg_30d"
        validation_rules:
          - field: energy_kwh
            operator: gt
            value: "0"
            error_code: "M001"
        registry_compatibility: [verra, gold_standard]
    expected:
      methodology_approved:
        name: "Thermoelectric Waste Heat v1.0"
        status: approved

  - name: "Verifier registration — happy path"
    description: "Register verifier key and verify emission"
    inputs:
      register_verifier:
        verifier_id: "0xCCDD...0001"
        name: "ThermogenZero Primary Witness"
        capabilities: [thermoelectric, solar]
        max_attestation_rate: 100
        status: active
    expected:
      verifier_registered:
        name: "ThermogenZero Primary Witness"
        status: active

  - name: "Parameter change — quorum not met"
    description: "Propose parameter change, insufficient votes, verify rejection"
    inputs:
      propose_parameter_change:
        parameter_path: "verifier.quorum_size"
        current_value: "3"
        proposed_value: "5"
        rationale: "Increase quorum for higher assurance"
    expected:
      proposal_result:
        status: expired

  - name: "Vote validation — invalid signature"
    description: "Submit vote with invalid ML-DSA-87 signature, verify rejection"
    inputs:
      cast_vote:
        proposal_id: "0xEEFF...0001"
        voter: "0x1122...UNAUTHORIZED"
        vote: true
        signature: "0xINVALID"
    expected:
      error:
        code: E7090
        reason: "invalid_governance_key"
